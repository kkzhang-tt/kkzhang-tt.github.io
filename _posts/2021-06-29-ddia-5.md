---

layout: post
title: "DDIA：数据复制"
category: "ddia"
author: "kkzhang"
image: ddia_5_1.jpg
---

复制主要是指**通过网络在多台机器上保存相同的数据副本**。通过数据复制，我们期望能够达到以下目的：

- **降低访问延迟**：使数据在地理位置上更接近用户
- **提高可用性**（容错）：当部分节点异常，系统仍然可以继续提供服务
- **提高读吞吐量**：多个数据副本可以同时提供数据访问服务

> 在讨论数据复制时，假设集群中的每一台机器都能保存完整的数据集副本。

数据复制的难点在于如何处理持续更新的数据；常见的数据复制方法有三种：**主从复制，多主节点复制，无主节点复制**。

# 主节点与从节点

每个保存数据库完整数据集的节点称为*副本*。当存在多个副本，如何保证不同副本之间的数据一致性是需要考虑的问题。常见的解决方案基于主从复制，其基本流程如下：

1. 指定某个副本为主副本。当客户端写数据时，必须将写请求发送给主节点；而主节点首先将数据写入本地存储
2. 其他副本称为从副本。*主节点将新数据写入本地之后，再将数据更改作为复制的日志或者更改流发送给所有的从副本。每个从副本获得更改日志后将其应用到本地，并且严格保持与主副本相同的写入顺序。*
3. 客户端从数据库中读数据时，可以在主副本或者从副本上执行查询。

> 只有主副本可以接受写请求，从副本只读

![]({{site.baseurl}}/images/ddia_5_1.png)

# 同步复制与异步复制

在将数据由主节点复制到从节点时，可以选择使用***同步复制***还是***异步复制***。

结合上图的流程，假设用户需要更新自己的首页头像图片，基本流程为：用户将更新请求发送到主节点，主节点收到更新请求并更新自身数据，之后将数据更新发送给从节点。之后，主节点通知用户更新完成。

![]({{site.baseurl}}/images/ddia_5_2.png)

> 主从复制，包括一个同步的从节点，一个异步的从节点

在上图中，从节点 1 同步复制：*主节点需要等待直到从节点 1 完成写入*；

从节点 2 异步复制：*主节点发送完消息之后立即返回，不用等待从节点 2 的完成确认*。

对于异步复制，可能会导致从节点落后主节点较长的时间；比如从节点 2 在收到复制日志之前，有较大的延迟。

> 对于主从复制，系统并没有保证一定会在多久时间内完成复制

## 同步 VS 异步

1. 同步复制的优点：一旦向用户确认，从节点可以明确保证**完成了与主节点的更新同步，数据已经处于最新版本**。即使此时主节点发生了故障，也是可以在从节点继续访问最新的数据。
2. 同步复制的缺点：如果同步的从节点无法完成同步确认（可能是从节点崩溃，或者网络故障等），那么用户写入就不能视为成功。**主节点会阻塞其后所有的写操作，直到同步副本确认完成，从而影响整体的性能**。
3. 异步复制的优点：不管从节点上数据多么滞后，主节点总是可以继续响应写请求，**系统的吞吐性能更好**。
4. 异步复制的缺点：如果主节点发生故障且不可恢复，那么所有尚未复制到从节点的写请求都会丢失。意味着即使向客户端确认了写操作，**却无法保证数据的持久化**。

结合上述优缺点，如果把所有的从节点设置为同步复制，那么任何一个同步节点的中断都会导致整个系停滞不前。所以在实践中，通常是其中一个从节点是同步的，而其他节点是异步模式。这样可以保证至少两个节点拥有最新的数据副本，这种配置也被称为**半同步**。