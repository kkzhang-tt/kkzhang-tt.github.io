---

layout: post
title: "Lion: Multi-Region Data Synchronization"
category: "system-design"
author: "kkzhang"
---
# 1ã€æ–‡æ¡£æ¦‚è¿°

## 1.1Â é¡¹ç›®èƒŒæ™¯

Lion ç›®å‰éƒ¨ç½²åœ¨åŒ—äº¬ï¼Œä¸Šæµ·ä¸¤ä¾§æ•°æ®ä¸­å¿ƒï¼ŒåŒ—ä¸Šä¸¤åœ°åŒå‘åŒæ­¥ã€‚å¯¹äºæœªæ¥æ€€æ¥ï¼Œé¦™æ¸¯æˆ–è€…å…¶ä»–æ•°æ®ä¸­å¿ƒçš„è§„åˆ’ï¼ŒLion æš‚ä¸æ”¯æŒå…¶ä»–æ•°æ®ä¸­å¿ƒçš„æ•°æ®åŒæ­¥ã€‚

çŸ­æœŸå†…å¯ä»¥é€šè¿‡ Region å†…æµé‡é—­ç¯ï¼Œæ•°æ®è®¿é—®ä»ä½¿ç”¨åŒ—ä¸Šä¸¤åœ°æ•°æ®ä¸­å¿ƒçš„æ–¹æ¡ˆä¸´æ—¶æ”¯æŒï¼Œé•¿æœŸéœ€è¦æ¢ç´¢æ”¯æŒå¤šæ•°æ®ä¸­å¿ƒåŒæ­¥åŠŸèƒ½ã€‚

## 1.2Â é¡¹ç›®ç›®æ ‡

- æ”¯æŒå¤šæ•°æ®ä¸­å¿ƒé—´æ•°æ®åŒæ­¥ï¼ˆåŒæ­¥æ–¹å‘å¯è‡ªå®šä¹‰è®¾ç½®ï¼‰
- åŒä¸€ Region å†…æ•°æ®å’Œæµé‡é—­ç¯

## 1.3Â åè¯è§£é‡Š

| åè¯ | è§£é‡Š |
| --- | --- |
| DTS | ç¾å›¢å†…éƒ¨ä¸€ç§é›†æ•°æ®è®¢é˜…ã€æ•°æ®åŒæ­¥ã€æ•°æ®è¿ç§»äºä¸€ä½“çš„æ•°æ®ä¼ è¾“æœåŠ¡ |
| DRC | é¥¿äº†ä¹ˆæ•°æ®å¤åˆ¶ä¸­å¿ƒ |
| MGR | MySQL ç»„å¤åˆ¶ |
| Lion | ç¾å›¢å†…éƒ¨é…ç½®ç»Ÿä¸€ç®¡ç†å’Œå®æ—¶æ¨é€çš„å¹³å° |
| Lion Consistency | Lion ç³»ç»Ÿå†…è´Ÿè´£æ•°æ®åŒæ­¥æ¨¡å— |
| Lion Managerï¼ˆæ–°å¢ï¼‰ | Lion ç³»ç»Ÿå†…è´Ÿè´£åŒæ­¥ä»»åŠ¡ç®¡ç†æ¨¡å— |
| Lion Meta | Lion ç³»ç»Ÿå†…è´Ÿè´£æœåŠ¡æ³¨å†Œå‘ç°æ¨¡å— |
| Lion API/Console | Lion ç³»ç»Ÿå†… Open API åŠç®¡ç†ç«¯æ¨¡å— |

# 2ã€æ•´ä½“æ¶æ„

## 2.1 æŠ€æœ¯è°ƒç ”

### 2.1.1 æ‹“æ‰‘ç»“æ„è°ƒç ”

| æ‹“æ‰‘æ¨¡å‹ | æè¿° | æ¯”è¾ƒ | ç»“è®º |
| --- | --- | --- | --- |
| æ˜Ÿå‹æ‹“æ‰‘ | ä¸€ä¸ªæŒ‡å®šçš„æ ¹èŠ‚ç‚¹å°†å†™å…¥è½¬å‘ç»™æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ | ä¼˜ç‚¹ 1.åŒæ­¥é“¾è·¯ä¿æŒä¸€å®šçš„é¡ºåºï¼Œæ•°æ®ä¸€è‡´æ€§å¯ä»¥å¾—åˆ°æå‡; 2.è¿ç»´ç›¸å¯¹ç®€å•ã€‚ç¼ºç‚¹ï¼š1.ç”±äºæ•°æ®åŒæ­¥éœ€è¦é€šè¿‡ä¸­é—´èŠ‚ç‚¹è½¬å‘ï¼Œä¸­é—´èŠ‚ç‚¹å¯èƒ½ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œå®¹æ˜“å‡ºç°å•ç‚¹æ•…éšœï¼Œç³»ç»Ÿå®¹é”™é™ä½;2.ç”±äºé¡ºåºåŒæ­¥ï¼Œä½¿å¾—æ•´ä½“æ•°æ®åŒæ­¥å»¶è¿Ÿä¼šå¢å¤§ï¼ˆèŠ‚ç‚¹æ•°è¶Šå¤šï¼Œå»¶è¿Ÿè¶Šå¤§ï¼‰ | é‡‡ç”¨æ˜Ÿå‹æ‹“æ‰‘ç»“æ„:1.è¶…è¿‡2/3çš„é…ç½®å˜æ›´é›†ä¸­åœ¨åŒ—äº¬ï¼Œåç»­æ€€æ¥ï¼Œä¸Šæµ·å¯ä»¥ä»¥åŒ—äº¬ä¸ºä¸»è¿›è¡ŒåŒæ­¥;2.ä»¥åŒ—äº¬ä¸ºä¸»ï¼Œåœ¨æ•°æ®å†²çªï¼Œä¸€è‡´æ€§ä¿è¯æ–¹é¢å¤„ç†ç›¸å¯¹ç®€å•ï¼ŒåŒ…æ‹¬å¢é‡ä¸€è‡´æ€§æ£€æµ‹åŠŸèƒ½å®ç°
|
| å…¨éƒ¨è‡³å…¨éƒ¨å‹ï¼ˆç½‘çŠ¶å‹ï¼‰ | æ¯ä¸ªä¸»èŠ‚ç‚¹å°†å…¶å†™å…¥åŒæ­¥åˆ°å…¶ä»–æ‰€æœ‰ä¸»èŠ‚ç‚¹ | ä¼˜ç‚¹:1.æ•°æ®åŒæ­¥é“¾è·¯æ›´å¯†é›†ï¼Œæ•°æ®å¯ä»¥æ²¿ç€ä¸åŒè·¯å¾„ä¼ æ’­ï¼Œé¿å…äº†å•ç‚¹æ•…éšœï¼Œå®¹é”™æ€§æ›´é«˜;2.æ•°æ®å˜æ›´å…¨é“¾è·¯å¹¿æ’­ï¼Œæ•´ä½“åŒæ­¥å»¶è¿Ÿç›¸å¯¹æ›´ä½. ç¼ºç‚¹:1.åŒæ­¥é“¾è·¯é¡ºåºæ— æ³•å¾—åˆ°ä¿éšœï¼Œæ•°æ®å†²çªçš„æƒ…å†µæ›´å¤æ‚ï¼ˆå¯èƒ½æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦å¤„ç†å†²çªï¼‰;2.è¿ç»´æ›´åŠ å¤æ‚ | - |

### **2.1.2 åŒæ­¥æ–¹æ¡ˆè°ƒç ”**

| ä¸šç•Œæ–¹æ¡ˆ | éƒ¨ç½²æ¶æ„ | æ•´ä½“ä»‹ç» | å¤‡æ³¨ |
| --- | --- | --- | --- |
| ç¾å›¢ DTS | - | 1.Reader æ¨¡å—ä¸æº DB åŒåœ°åŸŸéƒ¨ç½²ï¼Œä»æº DB dump Binlogï¼Œå¹¶å­˜å‚¨åœ¨æœ¬åœ°å†…å­˜ä¸ç£ç›˜ä¸­; 2.Writer æ¨¡å—ä¸ç›®æ ‡ DB åŒåœ°åŸŸéƒ¨ç½²ï¼Œä» Reader ä¸­æ¶ˆè´¹ Binlogï¼Œå¹¶å°†æ•°æ®å†™å…¥ç›®æ ‡ DB ä¸­; 3.Reader ä¸ Writer ä¹‹é—´é€šè¿‡ç§æœ‰åè®®å®ç°é«˜é€Ÿä¼ è¾“ï¼›ä»»åŠ¡è°ƒåº¦ä¾èµ– Lion é…ç½®ä¸‹å‘ | [DTS](https://km.sankuai.com/collabpage/1479786749) |
| é¥¿äº†ä¹ˆ DRC | - | 1.Replicator æ¨¡å—ï¼šç”¨äºè§£ææº DB çš„ Binlogï¼Œå¹¶ç¼“å­˜åˆ°ä¸€ä¸ªè¶…å¤§çš„ Event Buffer ä¸­ï¼›åŒæ—¶å°†è§£æç»“æœé€šè¿‡ TCP æ¨åŠ¨åˆ°ç›®æ ‡ Applier æ¨¡å—;2.Applier æ¨¡å—ï¼šæ¥æ”¶ä» Replicator æ¨é€çš„æ•°æ®ï¼Œå¹¶å†™å…¥åˆ°ç›®æ ‡ DB ä¸­;3.Console æ¨¡å—ï¼šç”¨äºæ§åˆ¶ç®¡ç† | [DRC](https://km.sankuai.com/collabpage/1479723243) |

DTS ä¸ DRC åœ¨æ¶æ„éƒ¨ç½²ä¸Šæ¯”è¾ƒç±»ä¼¼ï¼Œæœ‰ä¸€äº›å…±é€šçš„åœ°æ–¹ï¼š

1. **è¯»å†™åˆ†ç¦»**ï¼šBinlog è®¢é˜…ä¸å›æ”¾é€»è¾‘æ‹†åˆ†ä¸ºä¸¤ä¸ªæ¨¡å—ï¼šReaderï¼ŒWriterï¼Œè¿›è¡Œè¯»å†™åˆ†ç¦»ï¼›ä¸¤ä¸ªæ¨¡å—å¯åˆ†åˆ«æŒ‰éœ€æ‰©å±•ï¼Œæé«˜ç³»ç»Ÿæ‰©å±•æ€§
2. **åŒåœ°åŸŸéƒ¨ç½²**ï¼šReader æ¨¡å—ä¸æº DB åŒåœ°åŸŸéƒ¨ç½²ï¼ŒWriter æ¨¡å—ä¸ç›®æ ‡ DB åŒåœ°åŸŸéƒ¨ç½²ï¼›Reader ä¸ Writer ä¹‹é—´é€šè¿‡ç§æœ‰åè®®é«˜é€Ÿä¼ è¾“
3. **ä¸­å¿ƒåŒ–ç®¡ç†**ï¼šReader/Writer æ¶‰åŠçš„è®¢é˜…ä¸å›æ”¾ä»»åŠ¡åˆ†é…éƒ½æ˜¯é€šè¿‡ä¸­å¿ƒæ¨¡å—ç»Ÿä¸€è°ƒåº¦ï¼Œè€Œä¸æ˜¯ç”± Reader/Writer æ¨¡å—åˆ†åˆ«ç®¡ç†
4. **Log æ‰“æ ‡**ï¼šä¸ºäº†é¿å…æ•°æ®å›ç¯ï¼Œå¯¹äº§ç”Ÿçš„ Log è¿›è¡Œæ‰“æ ‡ï¼Œæ ‡è¯†åœ°åŸŸä¿¡æ¯ï¼Œåœ¨å›æ”¾æ—¶è¿›è¡Œè¿‡æ»¤

å¯¹ä¸Šè¿°å‡ ç‚¹ Lion åœ¨è®¾è®¡è¿‡ç¨‹ä¸­åŸºæœ¬éƒ½å¯ä»¥å€Ÿé‰´ï¼Œä¸è¿‡ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼ŒReader/Writer æ¨¡å—ä¸è¿›è¡Œæ‹†åˆ†ï¼Œåˆå¹¶éƒ¨ç½²ï¼ˆä¸è¿‡ä»ç„¶è¿›è¡Œé€»è¾‘ä¸Šè§’è‰²åŒºåˆ†ï¼‰ã€‚


ğŸ’¡ **Qï¼šä¸ºä»€ä¹ˆ Lion ä¸è€ƒè™‘ç›´æ¥æ¥å…¥ DTS ï¼Ÿ**
Aï¼š1. DTS ç›®å‰æ‰€æœ‰è¿ç»´åŠ¨ä½œã€é«˜å¯ç”¨å¼ºä¾èµ– Lionï¼Œå»æ‰ Lion å¼ºä¾èµ–çš„æƒ…å†µä¸‹æ”¹é€ æˆæœ¬é«˜ï¼Œå¹¶ä¸” SLA æ— æ³•ä¿è¯
      2. DTS ç›®å‰åœ¨è¿ç»´ã€å®•æœºç­‰åœºæ™¯å­˜åœ¨æ•°æ®å›æº¯ï¼Œä¸æ»¡ è¶³Lion ä½å»¶è¿Ÿã€æ•°æ®ä¸å›é€€ï¼ˆé…ç½®ç‰ˆæœ¬å›é€€ï¼‰è¦æ±‚
      3. å¦‚æœå¤šä¸­å¿ƒä¹‹é—´ä¸¤ä¸¤äº’å¤‡ï¼ŒDTS é’ˆå¯¹è¿™ç§å¤æ‚é“¾è·¯ï¼Œæ•°æ®è¿ç§»æ‹†åˆ†çŸ­æœŸæ²¡æœ‰æ¯”è¾ƒå¥½çš„è§£å†³æ–¹

**Qï¼šDTS ä¸ DRC éƒ½æ˜¯é€šè¿‡ Binlog è®¢é˜…ä¼ è¾“å®ç°æ•°æ®å¤åˆ¶ï¼ŒLion æ˜¯å¦ä¹Ÿé‡‡å–è¯¥æ–¹æ¡ˆï¼Ÿ**
Aï¼šLion åŒæ­¥æ•°æ®æ¨¡å‹é‡‡ç”¨è‡ªå®šä¹‰ Log ç»“æ„ã€‚
      ç›®å‰ Lion åŒ—ä¸Šæ•°æ®ä¸­å¿ƒé—´åŒæ­¥ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰ Log æ•°æ®ï¼Œè€ƒè™‘åˆ°å¼•å…¥ MGR Binlog è®¢é˜…è§£ææµç¨‹å¹¶ä¸ä¼šå¯¹åŒæ­¥æµç¨‹æœ‰æ˜¾è‘—çš„æå‡ï¼Œå¹¶ä¸”ä¼šæé«˜è¿ç»´å¤æ‚åº¦ã€‚
      åŒæ—¶ï¼ŒLion åŒ—ä¸Šå­˜é‡æ•°æ®ï¼ˆConfig, Releaseç­‰è¡¨ï¼‰å¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œæš‚æ—¶æ— æ³•ç›´æ¥é‡‡ç”¨ Binglog è¿›è¡ŒåŒæ­¥ã€‚æ¯”å¦‚ï¼Œç”±äºåŒä¸€æ¡é…ç½®åœ¨åŒ—ä¸Šæœ€æ–°ç‰ˆæœ¬å·å¹¶ä¸ç›¸åŒï¼Œå¦‚æœä»æ•°æ®åº“å±‚é¢å¼ºè¡Œä¿æŒä¸€è‡´ï¼Œä¼šè§¦å‘ä¸€ä¾§ä¸šåŠ¡é‡æ–°è¿›è¡Œå…¨é‡é…ç½®åŠ è½½ï¼Œæœ‰è¾ƒå¤§çš„é£é™©ã€‚
      å› æ­¤ï¼ŒLion ä»ä¿ä½¿ç”¨è‡ªå®šä¹‰ Log ç»“æ„ã€‚


### 2.1.3 æ¨æ‹‰é€‰å‹

è¿™é‡Œçš„æ¨æ‹‰æ¨¡å‹æŒ‡çš„æ˜¯ Reader ä¸ Writer ä¹‹é—´ä¼ è¾“ Log çš„æ–¹å¼ï¼š1. Reader ä¸»åŠ¨å°† Log æ¨é€åˆ° Writerï¼›2. Writer å®šæ—¶ä» Reader æŒ‰éœ€æ‹‰å– Logã€‚

## 2.2 è®¾è®¡æ€»ä½“æ€è·¯

### 2.2.1 éƒ¨ç½²æ¶æ„

![]({{site.baseurl}}/images/lion_data_synchronization/1.png)

ä»¥åŒ—äº¬ï¼Œä¸Šæµ·ä¸¤ä¸ªæ•°æ®ä¸­å¿ƒä¸ºä¾‹ï¼Œæ¯ä¸ªæ•°æ®ä¸­å¿ƒéƒ¨ç½²äº†å…¨é‡çš„ Lion æœåŠ¡ï¼ˆéƒ¨åˆ†æœåŠ¡æœªåœ¨å›¾ä¸­å±•ç¤ºï¼‰ã€‚é€šè¿‡åŒæ­¥é…ç½®å˜æ›´åˆ°å…¶ä»–æ•°æ®ä¸­å¿ƒï¼Œä½¿å¾—æ¯ä¸ªæ•°æ®ä¸­å¿ƒæ‹¥æœ‰å…¨é‡æ•°æ®ï¼Œèƒ½å¤Ÿç‹¬ç«‹æä¾›å®Œæ•´çš„ Lion åŠŸèƒ½ã€‚

1. **MGR (DB)**ï¼šæŒä¹…åŒ–ä¸šåŠ¡é…ç½®æ•°æ®ï¼ŒåŒæ­¥æ—¥å¿—ï¼ŒåŒæ­¥ä»»åŠ¡å…ƒæ•°æ®ç­‰ä¿¡æ¯ã€‚MGR æœ‰ä¸¤ç§éƒ¨ç½²æ¨¡å¼ï¼š
    1. ***æ¯ä¸­å¿ƒå•ç‹¬éƒ¨ç½²***ï¼šå­˜å‚¨ä¸­å¿ƒå†…ä¸šåŠ¡æ•°æ®ï¼ˆå¦‚åŒæ­¥ä»»åŠ¡ç®¡ç†ç›¸å…³å…ƒæ•°æ®ï¼‰ï¼Œæ”¯æŒä¸­å¿ƒå†…æµé‡ä¸æ•°æ®é—­ç¯ã€‚ä¸åŒæ•°æ®ä¸­å¿ƒçš„ MGR æ•°æ®å®æ—¶åŒæ­¥ï¼Œæœ€ç»ˆæ¯ä¸ªæ•°æ®ä¸­å¿ƒæ‹¥æœ‰å…¨é‡ä¸šåŠ¡æ•°æ®ã€‚
    2. ***ç‰¹å®šä¸­å¿ƒéƒ¨ç½²***ï¼šå­˜å‚¨å…¬å…±æ•°æ®ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†ï¼ˆå¦‚åŒæ­¥æ¨¡å—èŠ‚ç‚¹æœ€æ–°åˆ—è¡¨ï¼‰ï¼Œæ”¯æŒä¸åŒæ•°æ®ä¸­å¿ƒçš„æœåŠ¡è¿›è¡Œè·¨åœ°åŸŸè®¿é—®ã€‚åªéƒ¨ç½²åœ¨æŒ‡å®šæ•°æ®ä¸­å¿ƒï¼ˆä¸Šæµ·ï¼‰ï¼Œä¾›æ‰€æœ‰æ•°æ®ä¸­å¿ƒè¿›è¡Œè®¿é—®ã€‚
2. **Consistency**ï¼šæ‰§è¡Œæ•°æ®åŒæ­¥ä»»åŠ¡ï¼›æ¯ä¸­å¿ƒå•ç‹¬éƒ¨ç½²
    - æ— çŠ¶æ€æœåŠ¡ï¼›é€»è¾‘ä¸Šåˆ’åˆ†ä¸º Readerï¼ŒWriter ä¸¤ç§è§’è‰²
    - ***Reader***ï¼šå¯¹å¤–æš´éœ² HTTP API æ¥å£ï¼Œæä¾›åŒæ­¥æ—¥å¿—æŸ¥è¯¢åŠŸèƒ½
        
        > åŠŸèƒ½å¾ˆè½»é‡ï¼šæä¾› API æ¥å£ä¾› Writer è®¿é—®
        > 
    - ***Writer***ï¼šè°ƒç”¨ Reader æ¥å£ï¼Œå®ç°åŒæ­¥æ—¥å¿—åœ¨æ•°æ®ä¸­å¿ƒé—´ä¼ è¾“é€»è¾‘ï¼›åŒæ—¶å®Œæˆæ—¥å¿—å­˜å‚¨ï¼Œå›æ”¾ç­‰åŠŸèƒ½ã€‚
        - åœ¨è®¿é—®å…¶ä»–æ•°æ®ä¸­å¿ƒçš„ Reader ä¹‹å‰ï¼Œä¼šä» Meta æŸ¥è¯¢å¼‚åœ°æ•°æ®ä¸­å¿ƒå†… Reader å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨ï¼ˆç¼“å­˜åœ¨æœ¬åœ°ï¼Œå®šæ—¶æ›´æ–°ï¼‰
        - æ¯ä¸ª Writer ä»»åŠ¡åŒæ­¥ç‰¹å®šåˆ†åŒºçš„æ—¥å¿—ï¼Œå¹¶å°†æœ€æ–°åŒæ­¥åç§»é‡ä¸ŠæŠ¥åˆ° Manager
        - Writer ç”Ÿå‘½å‘¨æœŸç”± Manager è¿›è¡Œç®¡ç†ï¼Œä¼šå‘¨æœŸæ€§ä¸ŠæŠ¥è‡ªèº«çŠ¶æ€
    
    > ä¸ºäº†æé«˜åŒæ­¥æ‰©å±•æ€§ï¼Œå°†åŒæ­¥æ—¥å¿—è¿›è¡Œåˆ‡ç‰‡ï¼Œæ¯ä¸ª Writer ä»»åŠ¡åªä¼šåŒæ­¥æŒ‡å®šåˆ‡ç‰‡çš„æ—¥å¿—ã€‚
    > 
    
    > åŒæ­¥èŠ‚ç‚¹ : åŒæ­¥ä»»åŠ¡ = 1 : N (æ¯ä¸ªåŒæ­¥èŠ‚ç‚¹ä¸Šå¯èƒ½ä¼šè¿è¡Œå¤šä¸ªåŒæ­¥ä»»åŠ¡)
    > 
    
    > åŒæ­¥ä»»åŠ¡ : åŒæ­¥åˆ†åŒº = 1 : 1 (æ¯ä¸ªåŒæ­¥ä»»åŠ¡åªä¼šåŒæ­¥ä¸€ä¸ªåˆ†åŒºå†…çš„æ—¥å¿—)
    > 
3. **Manager (æ–°å¢)**ï¼šç”¨äºåŒæ­¥å…ƒæ•°æ®ç®¡ç†ï¼ŒåŒæ­¥ä»»åŠ¡è°ƒåº¦ï¼›æ¯ä¸­å¿ƒå•ç‹¬éƒ¨ç½²
    - ***ç®¡ç†åŒæ­¥å…ƒæ•°æ®***ï¼š1. åŒæ­¥èŠ‚ç‚¹ï¼ˆConsistencyï¼‰ä¸åŒæ­¥åˆ†åŒºï¼ˆPartitionï¼‰ç´¢å¼•çš„æ˜ å°„å…³ç³»ï¼›2. åŒæ­¥åˆ†åŒºæœ€æ–°åŒæ­¥åç§»é‡ï¼ˆOffsetï¼‰
    - ***åŒæ­¥ä»»åŠ¡è°ƒåº¦***ï¼š1. åœ¨åŒæ­¥èŠ‚ç‚¹ä¸Šï¼Œæ ¹æ®åˆ†åŒºç´¢å¼•åˆ›å»ºå¯¹åº”åŒæ­¥ä»»åŠ¡ï¼›2. åˆ†åŒºç´¢å¼•è¿ç§»æ—¶ï¼Œå®ŒæˆåŒæ­¥ä»»åŠ¡è¿ç§»ï¼›3. ä¸åŒæ­¥ä»»åŠ¡ä¹‹é—´ç»´æŒå¿ƒè·³ï¼Œç¡®ä¿åŒæ­¥ä»»åŠ¡å¤„äºè¿è¡ŒçŠ¶æ€
    - æ¯ä¸ªæ•°æ®ä¸­å¿ƒå†…éƒ¨ç½²å¤šä¸ª Manager èŠ‚ç‚¹ï¼Œä½œä¸ºåŒæ­¥ä»»åŠ¡è°ƒåº¦çš„ä¸­å¿ƒæ¨¡å—ï¼š
        1. ä¸ä¸­å¿ƒå†…åŒæ­¥èŠ‚ç‚¹ï¼ˆConsistencyï¼‰å‘¨æœŸäº¤äº’ï¼š1. ä¸‹å‘åŒæ­¥ä»»åŠ¡åˆ›å»º/é”€æ¯çš„å‘½ä»¤ï¼›2. äº†è§£åŒæ­¥ä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼›3. ç¡®å®šåŒæ­¥ä»»åŠ¡æœ€æ–°åç§»é‡
        2. å®šæ—¶è½®è¯¢ Meta èŠ‚ç‚¹ï¼šæŸ¥è¯¢ä¸­å¿ƒå†… Consistency æœ€æ–°å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨ï¼Œåœ¨èŠ‚ç‚¹çŠ¶æ€å˜æ›´æ—¶è¿›è¡ŒåŒæ­¥åˆ†åŒº Rehash åŠåŒæ­¥ä»»åŠ¡è¿ç§»
        3. ä»ä¸­å¿ƒå†… MGR åŠ è½½åŒæ­¥ä»»åŠ¡å…ƒæ•°æ®ï¼›å°†æœ€æ–°å…ƒæ•°æ®æŒä¹…åŒ–åˆ° MGR
    
    æ¯ä¸ª Manager èŠ‚ç‚¹éƒ½å¯ä»¥è¿›è¡Œä»»åŠ¡ç®¡ç†ï¼ˆå¹¶ä¸æ˜¯ä¸»ä»æ¶æ„ï¼‰ï¼Œä¸ºäº†å‡å°‘å¤šä¸ª Manager ç®¡ç†å†²çªï¼Œå¼•å…¥ç®€å•çš„åˆ†å¸ƒå¼é”ï¼ˆLion å†…éƒ¨å·²è¿è¡ŒéªŒè¯ï¼‰
    
4. **Meta**ï¼šæä¾› Lion ä¾§éƒ¨åˆ†æœåŠ¡æ³¨å†Œå‘ç°åŠŸèƒ½ï¼›æ¯ä¸­å¿ƒå•ç‹¬éƒ¨ç½²
    - åŒæ­¥èŠ‚ç‚¹ï¼ˆConsistencyï¼‰ä¸Šä¸‹çº¿æ—¶ï¼Œä¼šç”±æ•°æ®ä¸­å¿ƒå†…çš„ Meta èŠ‚ç‚¹ç»´æŠ¤å…¶å¯ç”¨çŠ¶æ€ï¼Œå¹¶***å°†ä¸­å¿ƒå†…æœ€æ–°å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨å­˜å‚¨åœ¨å…¬å…± DB ä¸­***
    - ***ä¸åŒæ•°æ®ä¸­å¿ƒçš„ Meta èŠ‚ç‚¹éƒ½å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®ä¸­å¿ƒçš„åŒæ­¥èŠ‚ç‚¹ï¼ˆConsistencyï¼‰åˆ—è¡¨è§†å›¾***
5. **API/Console**ï¼šLion ç®¡ç†ç«¯ / API æ¨¡å—ï¼Œä¸ºç”¨æˆ·æä¾›é…ç½®å˜æ›´/æŸ¥è¯¢ç­‰åŠŸèƒ½ï¼›æ¯ä¸­å¿ƒå•ç‹¬éƒ¨ç½²
    - æ¯æ¬¡é…ç½®å˜æ›´éƒ½ä¼šäº§ç”Ÿå¯¹åº”çš„åŒæ­¥æ—¥å¿—ï¼ˆLogï¼‰ï¼Œç”¨äºæ•°æ®ä¸­å¿ƒé—´é…ç½®åŒæ­¥
    - API/Console è¯·æ±‚çš„æµé‡ + è®¿é—®çš„æ•°æ®ä¼šåœ¨ä¸­å¿ƒå†…å®ç°é—­ç¯

### 2.2.2 æ•°æ®æ¨¡å‹

### 2.2.2.1 åŒæ­¥æ—¥å¿—

Lion åŒæ­¥æ—¥å¿—é‡‡ç”¨è‡ªå®šä¹‰ Logï¼Œè€Œé Binlogã€‚æ ¹æ®åŒæ­¥é˜¶æ®µçš„ä¸åŒï¼Œæˆ‘ä»¬å°† Log æ‹†åˆ†ä¸ºä¸¤ç§å½¢å¼ï¼š

1. **æºåŒæ­¥æ—¥å¿—ï¼ˆsource sync logï¼‰**ï¼šåŒ…å«å˜æ›´é…ç½®çš„è¯¦ç»†ä¿¡æ¯ã€‚é…ç½®å˜æ›´æ—¶ï¼Œåœ¨æœ¬åœ°æ•°æ®ä¸­å¿ƒäº§ç”Ÿä¸€æ¡æ—¥å¿—ï¼Œè¯¥æ—¥å¿—ä¼šè¢«å…¶ä»–æ•°æ®ä¸­å¿ƒåŠ è½½ï¼ŒåŒæ­¥ã€‚
    
    å…·ä½“è®¾è®¡
    
    | id | release_key | timestamp | key | appkey | set/swimlane/env | old_value | new_value |
    | --- | --- | --- | --- | --- | --- | --- | --- |
    | ä¸»é”® | å˜æ›´å”¯ä¸€æ ‡è¯† | å˜æ›´æ—¶é—´æˆ³ | é…ç½® key | é…ç½® appkey | é…ç½®å…¶ä»–æ ‡è¯† | æ—§å€¼ | æ–°å€¼ |
    
    åŒæ­¥æ–¹å‘ä¸º**ä¸Šæµ· -> åŒ—äº¬**æ—¶ï¼ŒåŒ—äº¬ä¾§çš„ Consistency(Writer) èŠ‚ç‚¹ä¸Šçš„åŒæ­¥ä»»åŠ¡ä¼šä¸æ–­ä»ä¸Šæµ·ä¾§æ‰¹é‡æ‹‰å–***æœªåŒæ­¥***çš„ SourceSyncLogã€‚
    
    > é€šè¿‡ Offset æ¥æ ‡è¯†å·²åŒæ­¥çš„ SourceSyncLogï¼ˆid > offset : æœªåŒæ­¥ï¼›id <= offset : å·²åŒæ­¥ï¼‰
    > 
2. **ç›®æ ‡åŒæ­¥æ—¥å¿—ï¼ˆtarget sync logï¼‰**ï¼šé€šè¿‡å›æ”¾è¯¥æ—¥å¿—ï¼Œå°†å…¶ä»–æ•°æ®ä¸­å¿ƒçš„æœ€æ–°é…ç½®æ›´æ–°åˆ°æœ¬åœ°æ•°æ®ä¸­å¿ƒï¼ˆç›®æ ‡åŒæ­¥æ—¥å¿—æ˜¯ç”±æºåŒæ­¥æ—¥å¿—è½¬åŒ–è€Œæ¥çš„ï¼‰ã€‚
    
    å…·ä½“è®¾è®¡
    
    | id | source_idc | source_idc_log_id | status | release_key | timestamp | key | appkey | set/swimlane/env | old_value | new_value |
    | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
    | ä¸»é”® | æºæ•°æ®ä¸­å¿ƒæ ‡è¯† | æºæ•°æ®ä¸­å¿ƒçš„ SourceSyncLog Id | åŒæ­¥çŠ¶æ€ | å˜æ›´å”¯ä¸€æ ‡è¯† | å˜æ›´æ—¶é—´æˆ³ | é…ç½® key | é…ç½® appkey | é…ç½®å…¶ä»–æ ‡è¯† | æ—§å€¼ | æ–°å€¼ |
    
    åŒæ­¥æ–¹å‘ä¸º**ä¸Šæµ· -> åŒ—äº¬**æ—¶ï¼ŒåŒ—äº¬ä¾§çš„åŒæ­¥ä»»åŠ¡å°†ä»ä¸Šæµ·ä¾§æ‹‰å–åˆ°çš„ SourceSyncLog è½¬åŒ–æˆ TargetSyncLogï¼Œå¹¶æ’å…¥æœ¬åœ° DBï¼›ä¹‹åä¼šæ ¹æ® TargetSyncLog å°†ä¸Šæµ·ä¾§çš„å˜æ›´å›æ”¾åˆ°æœ¬åœ°ã€‚
    

    ğŸ’¡ TargetSyncLog æ¯” SourceSyncLog å¤šäº† source_idc, source_idc_log_id, status å­—æ®µï¼Œä¸»è¦æ˜¯ä¸ºäº†é¿å…æ•°æ®å›ç¯ï¼Œæ ‡è¯†å·²åŒæ­¥ä½ç½®ç­‰
    
    

### 2.2.2.2 åŒæ­¥ä»»åŠ¡å…ƒæ•°æ®

æ•°æ®ä¸­å¿ƒé—´ Log ä¼ è¾“ç®€å•æ¥çœ‹å°±æ˜¯å°†å…¶ä»–æ•°æ®ä¸­å¿ƒçš„ Log å¤åˆ¶åˆ°æœ¬ä¾§æ•°æ®ä¸­å¿ƒï¼Œå¤åˆ¶è¿‡ç¨‹æœ‰å‡ ç‚¹éœ€è¦è€ƒè™‘ï¼š

- **åŒæ­¥é“¾è·¯æ§åˆ¶**ï¼šåº”è¯¥æ˜ç¡®å“ªäº›æ•°æ®ä¸­å¿ƒé—´å¯ä»¥è¿›è¡ŒåŒæ­¥ï¼Œæ•°æ®æ˜¯å•å‘åŒæ­¥è¿˜æ˜¯åŒå‘åŒæ­¥
- **åŒæ­¥ä»»åŠ¡æ‰©å±•æ€§åŠæ€§èƒ½**ï¼šå¦‚æœé›†ç¾¤ä¸­çš„å•ä¸ªåŒæ­¥èŠ‚ç‚¹éƒ½åŒæ­¥å…¨é‡ Logï¼Œå¯èƒ½ä¼šä½¿å¾—åŒæ­¥æ€§èƒ½è¾ƒä½ï¼Œå»¶è¿Ÿè¾ƒå¤§ï¼›åŒæ—¶ï¼Œé›†ç¾¤æ— æ³•æ°´å¹³æ‰©å®¹ï¼Œæ‰©å±•æ€§ä½ã€‚æˆ‘ä»¬åº”è¯¥å°†åŒæ­¥ Log ä»¥åˆ‡ç‰‡çš„å½¢å¼åˆ†é…ç»™å„ä¸ªé›†ç¾¤èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒæ­¥éƒ¨åˆ† Logï¼Œä»è€Œæé«˜é›†ç¾¤çš„æ‰©å±•æ€§åŠåŒæ­¥æ€§èƒ½
- **åŒæ­¥ç¨³å®šæ€§**ï¼šèŠ‚ç‚¹çŠ¶æ€ç»å¸¸å˜åŒ–ï¼ˆå®•æœº/é‡å¯/æ‰©å®¹/ä¸‹çº¿ï¼‰ï¼ŒåŒæ­¥ä»»åŠ¡ä¹Ÿéšä¹‹ä¸å¤ªç¨³å®šï¼›æˆ‘ä»¬åº”è¯¥ä¿è¯åœ¨åŒæ­¥ä»»åŠ¡é‡å¯/è¿ç§»/é”€æ¯æ—¶ï¼ŒLog åŒæ­¥å°½é‡ä¸é—æ¼ï¼Œä¸é‡å¤

é’ˆå¯¹ä¸Šé¢ä¸‰ç‚¹é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ç›¸åº”çš„é…ç½®è¿›è¡Œç®¡ç†ï¼š

### **2.2.2.2.1 åŒæ­¥è·¯ç”±é…ç½®ï¼ˆIDC Routersï¼‰**

**ç”¨äºæ§åˆ¶ä¸åŒæ•°æ®ä¸­å¿ƒé—´çš„åŒæ­¥æ–¹å‘**

| id | target_idc | source_idc | status | å¤‡æ³¨ |
| --- | --- | --- | --- | --- |
| ä¸»é”® | ç›®æ ‡æ•°æ®ä¸­å¿ƒ
ï¼ˆå½“å‰æ•°æ®ä¸­å¿ƒï¼‰ | æºæ•°æ®ä¸­å¿ƒ | åŒæ­¥æ˜¯å¦å¼€å¯ | æ•°æ®åŒæ­¥æ–¹å‘ï¼š
source -> target |

ç¤ºä¾‹ï¼šåŒ—äº¬ -> ä¸Šæµ·

| id | target_idc | source_idc | status |
| --- | --- | --- | --- |
| 1 | sh | bj | true |

### 2.2.2.2.2 åŒæ­¥åˆ†åŒºé…ç½®ï¼ˆPartitionsï¼‰

**åŒæ­¥èŠ‚ç‚¹ä¸åŒæ­¥åˆ†åŒºçš„æ˜ å°„å…³ç³»**

- åŒæ­¥åˆ†åŒºè®¾è®¡å‚è€ƒ Redis Cluster Slot å®ç°ï¼Œäººä¸ºæå‰è®¾å®šåˆ†åŒºæ€»æ•°ï¼Œå¦‚åˆ†åŒºæ€»æ•° 30ï¼Œåˆ†åŒºç´¢å¼•ä¸º [0, 1, 2, 3, 4 ... 29]ã€‚
    
    æ¯ä¸ªåŒæ­¥èŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†åˆ†åŒºç´¢å¼•é›†åˆï¼Œå¦‚ node_1:[0, 2, 4, 6]ï¼Œnode_2:[1, 3, 5]ã€‚
    
    åœ¨è¿›è¡Œ Log åŒæ­¥æ—¶ï¼Œå…ˆå¯¹ Log Key è¿›è¡Œ Hash å–æ¨¡ï¼Œè®¡ç®— Log å¯¹åº”çš„åˆ†åŒºç´¢å¼•ï¼Œå¦‚æœè¯¥ç´¢å¼•å€¼è½åœ¨åŒæ­¥èŠ‚ç‚¹ç»´æŠ¤çš„èŒƒå›´å†…ï¼Œåˆ™ç”±è¯¥èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥ï¼Œå¦åˆ™å¿½ç•¥ã€‚
    
    > é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ä¿è¯åŒä¸€ä¸ª key çš„å˜æ›´ä¼šç”±ç›¸åŒçš„åŒæ­¥èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥ï¼Œä¿è¯åŒæ­¥é¡ºåº
    > 

| id | node | source_idc | partition_indexes |
| --- | --- | --- | --- |
| ä¸»é”® | åŒæ­¥èŠ‚ç‚¹ï¼šConsistency(Writer) | æºæ•°æ®ä¸­å¿ƒ | åŒæ­¥åˆ†åŒºç´¢å¼•åˆ—è¡¨ |

ç¤ºä¾‹ï¼šä¸Šæµ·ä¾§åŒæ­¥åˆ†åŒºé…ç½®

| id | node | source_idc | partition_indexes |
| --- | --- | --- | --- |
| 1 | sh_node_1 | bj | [1, 2, 3, 4, 5] |
| 2 | sh_node_2 | bj | [6, 7, 8, 9, 10] |


ğŸ’¡ è¯¥é…ç½®è¡¨ç¤ºçš„æ˜¯*æœ¬åœ°æ•°æ®*ä¸­å¿ƒåŒæ­¥ä»»åŠ¡çš„é…ç½®ã€‚é€šå¸¸ï¼Œ**ä¸€ä¸ªåŒæ­¥èŠ‚ç‚¹å¯èƒ½è¿è¡Œå¤šä¸ªåŒæ­¥ä»»åŠ¡ï¼Œæ¯ä¸ªåŒæ­¥ä»»åŠ¡è´Ÿè´£åŒæ­¥ç‰¹å®šçš„åˆ†åŒºç´¢å¼• Logã€‚
åˆ†åŒºæ€»æ•°æå‰é…ç½®å¥½ï¼Œä¸”æ­£å¸¸æƒ…å†µä¸‹ä¿æŒä¸å˜ï¼›å°½é‡ä¿è¯åˆ†åŒºç´¢å¼•åœ¨åŒæ­¥èŠ‚ç‚¹ä¸­å‡åŒ€åˆ†é…ã€‚**
åŒæ­¥èŠ‚ç‚¹ : åŒæ­¥ä»»åŠ¡ = 1 : N (æ¯ä¸ªåŒæ­¥èŠ‚ç‚¹ä¸Šå¯èƒ½ä¼šè¿è¡Œå¤šä¸ªåŒæ­¥ä»»åŠ¡)
åŒæ­¥ä»»åŠ¡ : åŒæ­¥åˆ†åŒº = 1 : 1 (æ¯ä¸ªåŒæ­¥ä»»åŠ¡åªä¼šåŒæ­¥ä¸€ä¸ªåˆ†åŒº)


### **2.2.2.2.3 æ—¥å¿—åˆ†åŒºåç§»é‡é…ç½®ï¼ˆOffsetsï¼‰**

**è®°å½•æ¯ä¸ªåˆ†åŒºæœ€æ–°åŒæ­¥ä½ç½®**

| id | source_idc | partition_index | offset |
| --- | --- | --- | --- |
| ä¸»é”® | æºæ•°æ®ä¸­å¿ƒ | åŒæ­¥åˆ†åŒºç´¢å¼• | åŒæ­¥æ—¥å¿—åç§»é‡ |

ç¤ºä¾‹ï¼šåŒ—äº¬åˆ†åŒºåç§»é‡é…ç½®

| id | source_idc | partition_index | offset |
| --- | --- | --- | --- |
| 1 | bj | 1 | 10 |
| 2 | bj | 2 | 4 |
| 3 | bj | 3 | 5 |
| 4 | bj | 4 | 9 |


ğŸ’¡ åŒæ­¥ä»»åŠ¡å¢é‡åŒæ­¥æŒ‡å®šåˆ†åŒºçš„éƒ¨åˆ† Log ä¹‹åï¼Œæ›´æ–°è¯¥åˆ†åŒºçš„åç§»é‡ï¼ˆoffsetï¼‰ï¼Œä»¥ä¾¿**å½“åŒæ­¥ä»»åŠ¡é‡å¯/è¿ç§»åèƒ½å¤Ÿä»ä¸Šæ¬¡åŒæ­¥çš„ä½ç½®ç»§ç»­åŒæ­¥**ã€‚
æ¯ä¸ªæºæ•°æ®ä¸­å¿ƒä¸‹çš„æ¯ä¸ªåˆ†åŒºéƒ½éœ€è¦ç»´æŠ¤è‡ªèº«çš„ Offsetã€‚


### 2.2.3 Manager : åŒæ­¥ä»»åŠ¡è°ƒåº¦

![]({{site.baseurl}}/images/lion_data_synchronization/2.png)

å‰é¢æåˆ°ï¼Œä¸ºäº†æé«˜åŒæ­¥ä»»åŠ¡çš„æ‰©å±•æ€§ï¼Œå¯¹åŒæ­¥æ—¥å¿—è¿›è¡Œäº†åˆ‡ç‰‡å¤„ç†ï¼Œ**æ¯ä¸ªåŒæ­¥ä»»åŠ¡åªè´Ÿè´£ä¸€ä¸ªåˆ‡ç‰‡ï¼Œæ¯ä¸ªåŒæ­¥èŠ‚ç‚¹ä¸Šå¯è¿è¡Œå¤šä¸ªåŒæ­¥ä»»åŠ¡**ã€‚

Manager ä½œä¸ºåŒæ­¥ä»»åŠ¡ç®¡ç†çš„æ ¸å¿ƒæ¨¡å—ï¼Œä¸»è¦ä¸åŒæ•°æ®ä¸­å¿ƒå†…çš„åŒæ­¥èŠ‚ç‚¹ï¼ˆConsistencyï¼‰èŠ‚ç‚¹è¿›è¡Œäº¤äº’ï¼Œæ¶‰åŠåŠŸèƒ½æœ‰ï¼š

1. **åˆå§‹åŒ–åŒæ­¥ä»»åŠ¡**ï¼šåœ¨æ–°å¢æ•°æ®ä¸­å¿ƒï¼Œæ–°å¢åŒæ­¥/é›†ç¾¤èŠ‚ç‚¹ï¼ŒåŒæ­¥æœåŠ¡å¯åŠ¨æ—¶ï¼Œåœ¨åŒæ­¥èŠ‚ç‚¹ï¼ˆConsistencyï¼‰ä¸Šåˆå§‹åŒ–åŒæ­¥ä»»åŠ¡
2. **åŒæ­¥ä»»åŠ¡ç»´æŠ¤**ï¼šä¸»åŠ¨æ£€æµ‹åŒæ­¥èŠ‚ç‚¹ä¸Šå„ä¸ªä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼›åœ¨åŒæ­¥ä»»åŠ¡ä¸å¯ç”¨æ—¶ï¼ŒåŠæ—¶é”€æ¯æ—§ä»»åŠ¡ï¼Œåˆ›å»ºæ–°ä»»åŠ¡ï¼›å½“åŒæ­¥åˆ†åŒºè¿ç§»æ—¶ï¼Œä¸»åŠ¨åœ¨åŒæ­¥èŠ‚ç‚¹é—´è¿ç§»åŒæ­¥ä»»åŠ¡
3. **æ—¥å¿—åˆ†åŒºåˆ†é…**ï¼šå½“åŒæ­¥èŠ‚ç‚¹å˜æ›´æ—¶ï¼Œéœ€è¦å¯¹åˆ†åŒºè¿›è¡Œåˆ†é…ï¼Œä¿è¯ä¸åŒèŠ‚ç‚¹é—´åŒæ­¥è´Ÿè½½å°½å¯èƒ½å‡è¡¡ï¼ˆ*åŒæ­¥åˆ†åŒºçš„å˜æ›´ä¼šè§¦å‘åŒæ­¥ä»»åŠ¡çš„è¿ç§»*ï¼‰
    
    > ç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œç”±äººå·¥æ‰‹åŠ¨è¿›è¡Œåˆ†åŒºé…ç½®
    > 
4. **åŒæ­¥èŠ‚ç‚¹ç›‘å¬**ï¼šManager ä¼šå®šæ—¶ä» Meta æŸ¥è¯¢æœ€æ–°çš„åŒæ­¥èŠ‚ç‚¹åˆ—è¡¨ï¼Œå½“å‘ç”ŸèŠ‚ç‚¹å˜æ›´æ—¶ï¼Œè§¦å‘åˆ†åŒºé‡æ–°åˆ†é…
5. **åˆ†åŒºåç§»é‡ç»´æŠ¤**ï¼šåŒæ­¥ä»»åŠ¡åœ¨å®Œæˆå¢é‡æ—¥å¿—åŒæ­¥æ—¶ï¼Œä¼šä¸ŠæŠ¥å½“å‰åˆ†åŒºæœ€æ–°åç§»é‡å¹¶æŒä¹…åŒ–ï¼Œä»¥ä¾¿åç»­åŒæ­¥ä»»åŠ¡é‡å¯æ—¶èƒ½å¤Ÿä»æœ€æ–° Offset å¤„é‡æ–°åŒæ­¥

![]({{site.baseurl}}/images/lion_data_synchronization/3.png)

Manager ç®¡ç†æµç¨‹ç»†èŠ‚å¦‚ä¸‹ï¼š

1. Manager ä» DB ä¸­åŠ è½½ IDC Routersï¼ŒPartitions åŸæ•°æ®ï¼Œç”¨äºæ˜ç¡®æ•°æ®åŒæ­¥æ–¹å‘ï¼ˆsource->targetï¼‰ï¼ŒåŒæ­¥èŠ‚ç‚¹ç»´æŠ¤çš„åˆ†åŒºåˆ—è¡¨
2. Manager **å®šæ—¶ä¸åŒæ­¥èŠ‚ç‚¹é€šä¿¡**ï¼Œè·å–èŠ‚ç‚¹ä¸Šåˆ†åŒºåŒæ­¥ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼š{partition_index: task_status}
    1. å¦‚æœåŒæ­¥èŠ‚ç‚¹ç»´æŠ¤çš„åˆ†åŒºåˆ—è¡¨æ²¡æœ‰å¯¹åº”çš„åŒæ­¥ä»»åŠ¡æ‰§è¡Œï¼Œåˆ™åœ¨è¯¥åŒæ­¥èŠ‚ç‚¹ä¸Š**åˆå§‹åŒ–å¯¹åº”åˆ†åŒºåŒæ­¥ä»»åŠ¡**
    2. å¦‚æœåŒæ­¥èŠ‚ç‚¹ç»´æŠ¤çš„éƒ¨åˆ†åˆ†åŒºä»»åŠ¡æ‰§è¡ŒçŠ¶æ€å¼‚å¸¸ï¼Œåˆ™åœ¨è¯¥åŒæ­¥èŠ‚ç‚¹ä¸Š**æ–°å»ºå¯¹åº”åˆ†åŒºåŒæ­¥ä»»åŠ¡ï¼Œå¹¶é”€æ¯æ—§åŒæ­¥ä»»åŠ¡**
3. åœ¨åŒæ­¥ä»»åŠ¡æ­£å¸¸æ‰§è¡ŒæœŸé—´ï¼Œä¼šä¸ŠæŠ¥æœ€æ–°å·²åŒæ­¥åˆ†åŒºæ—¥å¿—åç§»é‡è‡³ Managerï¼Œå¹¶æŒä¹…åŒ–åˆ° Offsets è¡¨ä¸­
4. Manager å®šæ—¶ä» Meta æŸ¥è¯¢åŒæ­¥æ¨¡å—æœ€æ–°å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨
    1. å¦‚æœæ–°å¢/æ‘˜é™¤åŒæ­¥èŠ‚ç‚¹ï¼Œåˆ™ **Manager ä¼šå¯¹åŒæ­¥åˆ†åŒºè¿›è¡Œé‡æ–°åˆ†é…**ï¼Œå°½é‡ä¿è¯åˆ†åŒºå‡åŒ€åˆ†é…
    2. åˆ†åŒºé‡æ–°åˆ†é…ä¹‹åï¼Œéœ€è¦å¯¹åŒæ­¥ä»»åŠ¡è¿›è¡Œè¿ç§»ï¼Œç¡®ä¿**åŒæ­¥èŠ‚ç‚¹ç»´æŠ¤çš„åˆ†åŒºåˆ—è¡¨ä¸åŒæ­¥ä»»åŠ¡ä¸€ä¸€å¯¹åº”**

ä»ä¸Šé¢æµç¨‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

- **Offset åªä¼šç”±åŒæ­¥ä»»åŠ¡ä¸ŠæŠ¥å¹¶æ›´æ–°**ï¼› Offset ä¸ Partition ç»‘å®š
- **Partition é…ç½®åªåœ¨åŒæ­¥èŠ‚ç‚¹å‘ç”Ÿå˜æ›´çš„æ—¶å€™æ‰ä¼šå˜æ›´**ï¼›Partition ä¸åŒæ­¥èŠ‚ç‚¹ç»‘å®š

ğŸ’¡ Qï¼šæ•°æ®ä¸­å¿ƒåˆå§‹åŒ–é˜¶æ®µï¼ŒåŒæ­¥åˆ†åŒºå¦‚ä½•åˆ†é…çš„ï¼Ÿ
Aï¼šåˆå§‹é˜¶æ®µç”±äººå·¥æ‰‹åŠ¨ä¸ºåŒæ­¥èŠ‚ç‚¹è¿›è¡Œåˆ†åŒºåˆ†é…ï¼Œå¹¶ä¸”åˆ†åŒºæ€»æ•°éœ€è¦å¤§äºèŠ‚ç‚¹æ•°ã€‚å¦‚åŒæ­¥èŠ‚ç‚¹æ•°ä¸º 5ï¼Œåˆ†åŒºæ€»æ•°ä¸º 30.

Qï¼šå¤šä¸ª Manager ä¼šåŒæ—¶è¿›è¡Œä»»åŠ¡ç®¡ç†å—ï¼Ÿ
Aï¼šä¼šçš„ï¼ŒåŒä¸€æ•°æ®ä¸­å¿ƒå†…ä¼šæœ‰å¤šä¸ª Manager èŠ‚ç‚¹è¿›è¡Œç®¡ç†ï¼Œä¸ºäº†å‡å°‘å†²çªï¼Œå¯ä»¥æ›´æ–°å‰ä½¿ç”¨ç®€å•çš„åˆ†å¸ƒå¼é”ï¼ˆå·²åœ¨ Lion å½“å‰å®ç°ä¸­å¾—åˆ°éªŒè¯ï¼‰.


### 2.2.4 Consistency : å®æ—¶åŒæ­¥æ•°æ®

![]({{site.baseurl}}/images/lion_data_synchronization/4.png)

Manager åœ¨åŒæ­¥èŠ‚ç‚¹ï¼ˆConsistencyï¼‰ä¸Šåˆ›å»ºçš„åŒæ­¥ä»»åŠ¡ç”¨äºå®ç°ä¸åŒæ•°æ®ä¸­å¿ƒé—´æ•°æ®åŒæ­¥åŠŸèƒ½

1. ç”¨æˆ·åœ¨åŒ—äº¬ä¾§å˜æ›´é…ç½®ï¼ŒåŒ—äº¬ä¾§ DB ä¼šæ’å…¥ä¸€æ¡ SourceSyncLogï¼Œè¯¥ Log åŒ…å«äº†é…ç½®å˜æ›´çš„è¯¦ç»†ä¿¡æ¯
2. ä¸Šæµ·ä¾§åŒæ­¥ä»»åŠ¡ï¼ˆWriterï¼‰åœ¨è¿è¡Œæ—¶ï¼Œä¼šä» Manager **åŠ è½½å¯¹åº”åˆ†åŒºçš„åç§»é‡**ï¼ŒåŒæ—¶ä» Meta è·å–**åŒ—äº¬ä¾§ Consistency æœ€æ–°å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨**ï¼Œç”¨äºåç»­æ—¥å¿—æ‹‰å–
3. åŒæ­¥ä»»åŠ¡ï¼ˆWriterï¼‰**éšæœºè®¿é—®**åŒ—äº¬ä¾§ Consistencyï¼ˆReaderï¼‰èŠ‚ç‚¹ï¼Œæ ¹æ® Offset æ‰¹é‡åŠ è½½ SourceSyncLog
    1. å¯¹åŒ—äº¬ä¾§è¿”å›çš„æ—¥å¿—è¿›è¡Œè¿‡æ»¤ï¼Œ**è¿‡æ»¤å‡ºå±äºå½“å‰åˆ†åŒºç´¢å¼•çš„éƒ¨åˆ†æ—¥å¿—**ï¼ˆå¯¹é…ç½® key å– hashï¼‰
4. è¿‡æ»¤å®Œæˆåï¼ŒåŒæ­¥ä»»åŠ¡é¦–å…ˆå°†**è¿‡æ»¤ç»“æœæ—¥å¿—æ‰¹é‡ä¿å­˜åœ¨æœ¬åœ° DB**ï¼ˆTargetSyncLogï¼‰ä¸­
    1. æ­¤æ—¶ï¼Œä¿å­˜åœ¨æœ¬åœ°çš„ TargetSyncLog çš„ Status å­—æ®µé»˜è®¤ä¸º*æœªåŒæ­¥çŠ¶æ€*
5. éšåï¼ŒåŒæ­¥ä»»åŠ¡ï¼ˆWriterï¼‰å°†æ—¥å¿—ä¾æ¬¡å›æ”¾ï¼Œå°†åŒ—äº¬ä¾§çš„æœ€æ–°é…ç½®åŒæ­¥æœ¬åœ°
    1. åŒæ­¥æˆåŠŸä¹‹åï¼Œå°† TargetSyncLog çš„ Status å­—æ®µç½®ä¸º*åŒæ­¥æˆåŠŸçŠ¶æ€*
    2. å¦‚æœåŒæ­¥å¤±è´¥ï¼Œåˆ™åº”å°† Status å­—æ®µç½®ä¸º*åŒæ­¥å¤±è´¥çŠ¶æ€*
6. å°†å›æ”¾å®Œæˆçš„æ—¥å¿— **LogId ä½œä¸ºæœ€æ–°åˆ†åŒº Offset** ä¸ŠæŠ¥ç»™ Manager
    1. ä¸ç®¡å›æ”¾æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½éœ€è¦ä¸ŠæŠ¥ Offsetï¼Œä¼˜å…ˆä¿è¯ä¸é˜»å¡åç»­æ—¥å¿—åŒæ­¥ => å¯¹äºå¤±è´¥çš„æ—¥å¿—ï¼Œç”±åç»­è¡¥æ‰«ä»»åŠ¡ç»§ç»­åŒæ­¥
7. æœ¬æ‰¹æ¬¡åŒæ­¥å®Œæˆä¹‹åï¼Œå°†ä»¥æœ€æ–°çš„ Offset è¿›è¡Œä¸‹ä¸€æ¬¡åŒæ­¥æµç¨‹

> æ¯ä¸ªåŒæ­¥ä»»åŠ¡åªä¼šåŒæ­¥å±äºè‡ªèº«åˆ†åŒºçš„æ—¥å¿—ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸åŒèŠ‚ç‚¹ä¸Šçš„ä¸åŒåŒæ­¥ä»»åŠ¡ä¸ä¼šé‡å¤åŒæ­¥åŒä¸€æ¡æ—¥å¿—ï¼ˆå³ä½¿æœ‰å°‘é‡é‡å¤åŒæ­¥ä¹Ÿæ²¡å½±å“ï¼‰
> 


ğŸ’¡ Qï¼šæ—¥å¿—åŒæ­¥æµç¨‹æ˜¯å¦å¯ä»¥å°† Log æŒä¹…åŒ–åˆ° DB æ­¥éª¤ç§»é™¤ï¼Ÿ
Aï¼šæ—¥å¿—å›æ”¾è¿‡ç¨‹å¯èƒ½ä¼šå¤±è´¥ï¼Œé€šè¿‡å°† Log æŒä¹…åŒ–ï¼Œå¹¶æ ‡è¯†çŠ¶æ€ï¼Œå¯ä»¥æ–¹ä¾¿åç»­é‡æ–°åŒæ­¥ï¼Œä¿è¯ä¸é—æ¼

Qï¼šæ•´ä¸ªæµç¨‹åŸºæœ¬ä¸ºåŒæ­¥æ‰§è¡Œï¼Œæ˜¯å¦ä¼šå­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Ÿ
Aï¼šé€šè¿‡è®¾ç½®é€‚å½“å¤§å°çš„åˆ†åŒºï¼ˆå¦‚ 256ï¼‰ï¼Œå¹¶è€ƒè™‘ä»£ç å±‚é¢ä¼˜åŒ–ï¼ˆå¦‚çƒ­ç‚¹ key èšåˆï¼Œåˆ†åŒºå†…éƒ¨å† hashï¼‰ï¼ŒåŸºæœ¬èƒ½å¤Ÿæ»¡è¶³ Lion éœ€æ±‚


### 2.2.5 åŒæ­¥é›†ç¾¤èŠ‚ç‚¹å˜æ›´ä¸ä»»åŠ¡è¿ç§»

åœ¨æ—¥å¸¸è¿ç»´ä¸­ï¼Œé›†ç¾¤èŠ‚ç‚¹å˜æ›´æ˜¯ç»å¸¸å‘ç”Ÿçš„ï¼Œå¦‚æœåŠ¡å‘å¸ƒï¼Œå®¿ä¸»æœºå®•æœºï¼Œæ–°å¢æœºå™¨ç­‰ã€‚æˆ‘ä»¬éœ€è¦ä¿è¯é›†ç¾¤èŠ‚ç‚¹å˜åŒ–æ—¶ï¼Œæ•°æ®åŒæ­¥åŠŸèƒ½ä»ç¨³å®šæ‰§è¡Œã€‚é’ˆå¯¹è¿™ç±»é—®é¢˜ï¼Œè¿›ä¸€æ­¥è¿›è¡Œè®¨è®ºã€‚

![]({{site.baseurl}}/images/lion_data_synchronization/5.png)

æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸€éƒ¨åˆ†åˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå¯¹åº”ä¸€ä¸ªåŒæ­¥ä»»åŠ¡ã€‚å½“å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œè¯¥èŠ‚ç‚¹ç»´æŠ¤çš„åˆ†åŒºé›†åˆå°±ä¼šè¢«è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šï¼ŒåŒæ—¶åœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šåˆ›å»ºå¯¹åº”çš„åˆ†åŒºåŒæ­¥ä»»åŠ¡ã€‚

é‚£ä¹ˆï¼Œåœ¨åŒæ­¥ä»»åŠ¡è¿ç§»ï¼ˆåˆ†åŒºè¿ç§»ï¼‰è¿‡ç¨‹ä¸­ï¼Œèƒ½å¦ä¿è¯åŒæ­¥æµç¨‹ç¨³å®šæ‰§è¡Œï¼Ÿ

å›çœ‹ä¸‹åŒæ­¥ä»»åŠ¡çš„æ‰§è¡Œæ­¥éª¤ï¼Œè¿›ä¸€æ­¥åˆ†æï¼š

![]({{site.baseurl}}/images/lion_data_synchronization/6.png)

> åœ¨æ—¥å¿—ä»å¼‚åœ°åŠ è½½è¿‡æ»¤ä¹‹åï¼Œå°†ä¼šæŒä¹…åŒ–åˆ° DBã€‚ä¹‹åä¼šé€æ¡é¡ºåºå›æ”¾æ—¥å¿—ï¼Œå›æ”¾å®Œæˆåä¸ŠæŠ¥æœ€æ–° Offset
> 

| ä»»åŠ¡è¿ç§»æ—¶æœº | ç›´æ¥å½±å“ | åŒæ­¥ç¨³å®šæ€§å½±å“ |
| --- | --- | --- |
| Step 1: æ—¥å¿—åŠ è½½ | å½“å‰æ‰¹æ¬¡æ‹‰å–å¤±è´¥ | æ— å½±å“ï¼šç”±äº Offset æœªå˜åŒ–ï¼Œè¿ç§»åçš„æ–°ä»»åŠ¡ä¼šé‡æ–°ä»å½“å‰ä½ç½®æ‹‰å– |
| Step 2: æ—¥å¿—è¿‡æ»¤ï¼Œä¿å­˜ | æ‹‰å–çš„æ—¥å¿—ä¿å­˜å¤±è´¥ | æ— å½±å“ï¼šç”±äº Offset æœªå˜åŒ–ï¼Œè¿ç§»åçš„æ–°ä»»åŠ¡ä¼šé‡æ–°ä»å½“å‰ä½ç½®æ‹‰å–ï¼Œè¿‡æ»¤ï¼Œä¿å­˜ |
| Step 3: é€æ¡å›æ”¾æ—¥å¿— | è¯¥æ‰¹æ¬¡ logId > offset çš„æ—¥å¿—å›æ”¾å¤±è´¥ | å°‘é‡æ—¥å¿—é‡å¤åŒæ­¥ï¼šè¯¥æ‰¹æ¬¡ logId > offset çš„æ—¥å¿—ä¼šè¢«æ–°ä»»åŠ¡é‡æ–°åŒæ­¥ |
| Step 4: ä¸ŠæŠ¥ Offset | è¯¥æ¡å›æ”¾å®Œæˆçš„æ—¥å¿— logId æœªä¸ŠæŠ¥ | å°‘é‡æ—¥å¿—é‡å¤åŒæ­¥ï¼šè¯¥æ‰¹æ¬¡ logId > offset çš„æ—¥å¿—ä¼šè¢«æ–°ä»»åŠ¡é‡æ–°åŒæ­¥ |

å¯ä»¥çœ‹å‡ºï¼Œåœ¨åŒæ­¥ä»»åŠ¡æ‰§è¡Œé˜¶æ®µçš„ä»»ä½•æ—¶æœºè¿ç§»ï¼Œ**æœ€åçš„æƒ…å†µæ˜¯è¯¥æ‰¹æ¬¡æ—¥å¿—è¢«é‡å¤åŒæ­¥**ã€‚è€Œæˆ‘ä»¬çš„åŒæ­¥æµç¨‹æ”¯æŒå¹‚ç­‰ï¼Œä¸”æ—¥å¿—æ‰¹æ¬¡å¤§å°å¯æ§ï¼Œå› æ­¤ï¼Œå¯¹åŒæ­¥æµç¨‹çš„ç¨³å®šæ€§åŸºæœ¬æ²¡æœ‰å½±å“ã€‚

### 2.2.6 è¡¥æ‰«ä»»åŠ¡ï¼šé‡æ–°åŒæ­¥

åœ¨ Log å¤åˆ¶å¹¶åŒæ­¥åˆ°æœ¬åœ°æµç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå› ä¸º DB å¼‚å¸¸/ä»£ç é€»è¾‘ Bug ç­‰åŸå› å¯¼è‡´åŒæ­¥å¤±è´¥ï¼Œä¸ºäº†ä¸é˜»å¡åç»­å˜æ›´åŒæ­¥ï¼Œåœ¨é‡è¯•ä¸€å®šæ¬¡æ•°ä¹‹åï¼Œåº”è¯¥æ”¾å¼ƒã€‚

ä½†æ˜¯ï¼Œä¸ºäº†ä¿è¯é…ç½®æœ€ç»ˆåŒæ­¥æˆåŠŸï¼Œåº”è¯¥å¯¹åŒæ­¥å¤±è´¥çš„ Log è¿›è¡Œé‡æ–°åŒæ­¥ã€‚

![]({{site.baseurl}}/images/lion_data_synchronization/7.png)

1. è¡¥æ‰«ä»»åŠ¡å®šæ—¶ä» TargetSyncLog ä¸­åŠ è½½æœªåŒæ­¥æˆåŠŸï¼ˆå¯èƒ½æ˜¯åŒæ­¥å¤±è´¥ï¼Œä¹Ÿå¯èƒ½æ˜¯æœªåŒæ­¥ï¼‰çš„æ—¥å¿—ï¼ŒåŒæ ·æŒ‰ç…§åˆ†åŒºè¿›è¡Œè¿‡æ»¤
    
    > ä¸ºäº†é¿å…æ‰«æåˆ°åˆšå¤åˆ¶è¿‡æ¥ï¼Œä½†è¿˜æœªåŒæ­¥å®Œæˆä¸­çš„æ—¥å¿—ï¼Œè¡¥æ‰«ä»»åŠ¡éœ€è¦æ‰«æä¸€å®šæ—¶é—´èŒƒå›´å†…çš„æ—¥å¿—ï¼Œå¦‚ 1 åˆ†é’ŸèŒƒå›´å¤–
    > 
2. å¯¹æ‰«æåˆ°çš„æ—¥å¿—è¿›è¡Œé‡æ–°åŒæ­¥ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™æ›´æ–° Status å­—æ®µä¸ºåŒæ­¥æˆåŠŸçŠ¶æ€ï¼›å¦åˆ™ä»æ”¾å¼ƒï¼Œç­‰å¾…ä¸‹æ¬¡è¡¥æ‰«ä»»åŠ¡åŒæ­¥
    
    > å¤šæ¬¡è¡¥æ‰«åŒæ­¥ä»å¯èƒ½å¤±è´¥ï¼Œå› æ­¤éœ€è¦è®¾ç½®ä¸€ä¸ªåŒæ­¥é˜ˆå€¼ï¼Œè¶…è¿‡è¯¥é˜ˆå€¼ä»æœªæˆåŠŸï¼Œåˆ™è§¦å‘å‘Šè­¦ï¼Œäººå·¥ä»‹å…¥æ’æŸ¥åŸå› 
    > 

è¡¥æ‰«ä»»åŠ¡ä¸åŒæ­¥èŠ‚ç‚¹æ˜¯ 1 : 1 çš„å…³ç³»ï¼Œå³**ä¸€ä¸ªåŒæ­¥èŠ‚ç‚¹ä¸Šåªæœ‰ä¸€ä¸ªè¡¥æ‰«ä»»åŠ¡ï¼Œå¹¶ä¸”è¯¥è¡¥æ‰«ä»»åŠ¡è´Ÿè´£å¤šä¸ªæ—¥å¿—åˆ†åŒº**ã€‚

> å‡å¦‚åŒæ­¥èŠ‚ç‚¹è´Ÿè´£çš„åˆ†åŒºç´¢å¼•ä¸º [1, 2, 3]ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸‰ä¸ªå®æ—¶åŒæ­¥ä»»åŠ¡ï¼Œæ¯ä¸ªå®æ—¶åŒæ­¥ä»»åŠ¡åˆ†åˆ«è´Ÿè´£ä¸€ä¸ªåˆ†åŒºï¼›ä½†æ˜¯åªæœ‰ä¸€ä¸ªè¡¥æ‰«ä»»åŠ¡ï¼ŒåŒæ—¶è´Ÿè´£ [1, 2, 3] åˆ†åŒº
> 

### 2.2.7 ä¸€è‡´æ€§æ£€æµ‹

å®æ—¶åŒæ­¥ä¸è¡¥æ‰«åŒæ­¥æµç¨‹èƒ½å¤Ÿä¿è¯å¤§éƒ¨åˆ†æƒ…å†µä¸‹é…ç½®ä¸€è‡´æ€§ï¼ˆ>99.99%ï¼‰ï¼Œä»æœ‰å°æ¦‚ç‡ä¼šå‡ºç°é…ç½®ä¸ä¸€è‡´çš„æƒ…å†µã€‚

å› æ­¤é™¤äº†å®æ—¶åŒæ­¥ï¼Œè¡¥æ‰«åŒæ­¥ï¼Œè¿˜éœ€è¦å¢åŠ å¢é‡ä¸€è‡´æ€§æ£€æµ‹ä»»åŠ¡ï¼Œå¯¹äºä¸ä¸€è‡´çš„é…ç½®è¿›è¡Œå†æ¬¡æ£€æµ‹ä¸ä¿®å¤ã€‚

ç†æƒ³æƒ…å†µä¸‹ï¼Œå¢é‡ä¸€è‡´æ€§æ£€æµ‹ä»»åŠ¡æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š1. æ¯ä¸ªæ•°æ®ä¸­å¿ƒçš„åŒæ­¥èŠ‚ç‚¹æŒ‰ç…§ IDC Router é…ç½®ï¼Œä»ç›®æ ‡ IDC ä¸­æŸ¥è¯¢æŒ‡å®šé…ç½®çš„æœ€æ–°å€¼ï¼›2. å°†ç›®æ ‡ IDC è¿”å›çš„æœ€æ–°å€¼è¿›è¡Œæ¯”è¾ƒï¼ˆtimestamp æ¯”è¾ƒï¼‰ï¼Œå¦‚æœå¤šä¸ªæ•°æ®ä¸­å¿ƒçš„é…ç½®å€¼ä¸åŒï¼Œåˆ™é€‰æ‹©æœ€æ–°çš„é…ç½®å€¼ä½œä¸ºç›®æ ‡å€¼ï¼Œå¹¶æ›´æ–°æœ¬åœ°ã€‚

> ä¸¾ä¾‹ï¼ŒåŒ—äº¬ä¾§æœ‰ä¸ªé…ç½® key = lion-test.demoï¼ŒåŒ—äº¬ä¾§åŒæ­¥èŠ‚ç‚¹æŸ¥è¯¢ lion-test.demo åœ¨ä¸Šæµ·/æ€€æ¥/é¦™æ¸¯ä¾§çš„æœ€æ–°å€¼ï¼Œå¦‚æœè¿™å‡ ä¸ªæ•°æ®ä¸­å¿ƒçš„å€¼éƒ½ä¸åŒï¼Œåˆ™ä»¥æœ€æ–°å€¼ä¸ºä¸»ï¼Œå°†å…¶æ›´æ–°æœ¬åœ°
> 

è€ƒè™‘åˆ°å·²çŸ¥éœ€è¦æ”¯æ’‘çš„æ•°æ®ä¸­å¿ƒæœ‰åŒ—äº¬/ä¸Šæµ·/æ€€æ¥/é¦™æ¸¯ï¼Œå¦‚æœæŒ‰ç…§ä¸Šé¢æ‰§è¡Œæ­¥éª¤ï¼Œé‚£ä¹ˆæ£€æµ‹é“¾è·¯ä¸º 4*3ï¼Œæ¯ä¸¤ä¸ªæ•°æ®ä¸­å¿ƒé—´éƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡æ¯”è¾ƒï¼Œå¯¹äºä¸ä¸€è‡´å†²çªæƒ…å†µå¤„ç†æ¯”è¾ƒå¤æ‚ã€‚åç»­å¦‚æœéœ€è¦å†æ–°å¢æ•°æ®ä¸­å¿ƒï¼Œå†²çªå¤„ç†æƒ…å†µå°†ä¼šæ›´åŠ å¤æ‚ï¼Œä¸åˆ©äºç»´æŠ¤ã€‚

ç°åœ¨ Lion å·²ç»æœ‰åŒ—äº¬/ä¸Šæµ·ä¸¤ä¸ªæ•°æ®ä¸­å¿ƒï¼Œä¸Šæµ·ä¾§çš„å˜æ›´è¯·æ±‚åªæœ‰åŒ—äº¬ä¾§çš„ä¸€åŠï¼Œå¤§éƒ¨åˆ†å˜æ›´è§¦å‘æºéƒ½åœ¨åŒ—äº¬ï¼Œå³å¤§éƒ¨åˆ†æ•°æ®åŒæ­¥æ–¹å‘ä¸ºï¼šåŒ—äº¬ -> ä¸Šæµ·ã€‚

å› æ­¤ï¼Œä¸ºäº†ç®€åŒ–ä¸ä¸€è‡´å†²çªå¤„ç†ï¼Œæˆ‘ä»¬äººä¸º**ç»™æ•°æ®ä¸­å¿ƒè®¾ç½®ä¼˜å…ˆçº§ï¼šåŒ—äº¬ > æ€€æ¥ > ä¸Šæµ· > é¦™æ¸¯**ã€‚**åŒ—äº¬æ•°æ®ä¸­å¿ƒä½œä¸ºä¸»æ•°æ®ä¸­å¿ƒ**ï¼Œå…¶ä»–æ•°æ®ä¸­å¿ƒä»¥åŒ—äº¬ä¾§ä¸ºä¸»è¿›è¡Œå¢é‡ä¸€è‡´æ€§æ£€æµ‹ã€‚

ä½†æ˜¯ï¼Œå¦‚æœå…¶ä»–æ•°æ®ä¸­å¿ƒçš„æ•°æ®æ¯”åŒ—äº¬è¦æ–°ï¼Œåˆ™éœ€è¦åå“ºåŒ—äº¬ï¼Œæ›´æ–°åŒ—äº¬ä¾§æ•°æ®ã€‚

![]({{site.baseurl}}/images/lion_data_synchronization/8.png)

ä»¥ä¸Šæµ·æ•°æ®ä¸­å¿ƒå¢é‡æ£€æµ‹ä¸ºä¾‹ï¼ŒåŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

1. ä¸Šæµ·ä¾§ Consistency å¢é‡ä¸€è‡´æ€§æ£€æµ‹ä»»åŠ¡æŸ¥è¯¢æœ¬åœ°æŒ‡å®šæ—¶é—´èŒƒå›´å†…é…ç½®å˜æ›´åˆ—è¡¨
2. é€šè¿‡ HTTP è¯·æ±‚æŸ¥è¯¢åŒ—äº¬ä¾§å¯¹åº”é…ç½®çš„æœ€æ–°å€¼ï¼Œå¹¶è¿›è¡Œæ¯”è¾ƒæ—¶é—´æˆ³
    1. åå“ºï¼šå¦‚æœä¸Šæµ· Timestamp > åŒ—äº¬ Timestampï¼Œåˆ™å›è°ƒåŒ—äº¬ï¼Œåœ¨åŒ—äº¬ä¾§æ’å…¥ä¸€æ¡ TargetSyncLogï¼Œç­‰å¾…åç»­è¡¥æ‰«ä»»åŠ¡é‡æ–°åŒæ­¥
    2. ä¿®å¤ï¼šå¦‚æœä¸Šæµ· Timestamp <= åŒ—äº¬ Timestampï¼Œåˆ™åœ¨ä¸Šæµ·ä¾§æ’å…¥ä¸€æ¡ TargetSyncLogï¼Œç­‰å¾…åç»­è¡¥æ‰«ä»»åŠ¡é‡æ–°åŒæ­¥ï¼Œå®Œæˆä¿®å¤


ğŸ’¡ Qï¼šä¸ºä»€ä¹ˆæ—¥å¿—åŒæ­¥æ—¶æœªå¯¹æ•°æ®ä¸­å¿ƒè¿›è¡Œä¼˜å…ˆçº§åˆ’åˆ†ï¼Œç®€åŒ–åŒæ­¥æµç¨‹å‘¢ï¼Ÿ
Aï¼šå¦‚æœæ—¥å¿—åŒæ­¥ä¹ŸæŒ‰ç…§è¿™ç§æ–¹å¼å¤„ç†ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§ä½çš„æ•°æ®ä¸­å¿ƒçš„å˜æ›´å°±ä¸ä¼šåŒæ­¥åˆ°å…¶ä»–æ•°æ®ä¸­å¿ƒï¼Œä¸èƒ½æ»¡è¶³å¤šæ•°æ®ä¸­å¿ƒä¸€è‡´æ€§çš„ç›®æ ‡ã€‚
      ä» Lion ç°çŠ¶æ¥çœ‹ï¼Œç»è¿‡å®æ—¶åŒæ­¥ï¼Œè¡¥æ‰«åŒæ­¥ä¹‹åï¼ŒåŒ—ä¸Šæ•°æ®ä¸€è‡´æ€§çš„æ¯”ä¾‹ > 99.99%ã€‚è€Œå¢é‡ä¸€è‡´æ€§æ£€æµ‹æ˜¯å¯¹å®æ—¶åŒæ­¥ï¼Œè¡¥æ‰«åŒæ­¥çš„å…œåº•å¤„ç†ï¼Œå¯¹ä¸€äº›æå°‘æ•°é…ç½®ä¸ä¸€è‡´çš„æƒ…å†µè¿›è¡Œæ£€æµ‹ä¿®å¤ã€‚

Qï¼šä¸ºä»€ä¹ˆåªè€ƒè™‘å¢é‡ä¸€è‡´æ€§æ£€æµ‹ï¼Œä¸è€ƒè™‘å…¨é‡æ£€æµ‹ï¼Ÿ
Aï¼šå…¨é‡ä¸€è‡´æ€§æ£€æµ‹æˆæœ¬å¤ªé«˜ï¼Œä¸”ä» Lion ç°çŠ¶æ¥çœ‹ï¼Œå®æ—¶åŒæ­¥ & è¡¥æ‰«åŒæ­¥ & å¢é‡ä¸€è‡´æ€§æ£€æµ‹èƒ½å¤Ÿæ»¡è¶³ Lion å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ã€‚


### 2.2.8 æ•°æ®åŒæ­¥å¯ç”¨æ€§ä¿éšœ

### 2.2.8.1 å†²çªè§£å†³

æ¯æ¬¡é…ç½®å˜æ›´éƒ½ä¼šè®°å½•å˜æ›´æ—¶é—´æˆ³ï¼ˆtimestampï¼‰ï¼Œé»˜è®¤å†²çªè§£å†³ä¸ºæ¯”è¾ƒæ—¶é—´æˆ³è¿›è¡Œè¦†ç›–ã€‚

å¦‚æœæ—¶é—´æˆ³ç›¸åŒï¼Œåˆ™æ ¹æ® IDC ä¼˜å…ˆçº§è¿›è¡Œè¦†ç›–ï¼šBJ > HL > SH > HKã€‚

### 2.2.8.2 ä¸€è‡´æ€§ä¿è¯

1. åŒæ­¥æ—¥å¿—æŒä¹…åŒ–åˆ°æœ¬åœ° DBï¼ŒåŒæ­¥å¤±è´¥åä¼šè¿›è¡Œå¤šæ¬¡é‡è¯•ï¼ˆå®æ—¶åŒæ­¥ä¸è¡¥æ‰«åŒæ­¥å‡ä¼šé‡è¯•ï¼‰
2. æ¯æ‰¹æ¬¡ä»å…¶ä»–æ•°æ®ä¸­å¿ƒæˆåŠŸå¤åˆ¶æ—¥å¿—ä¹‹åï¼Œä¼šæŒä¹…åŒ–æœ€æ–°åˆ†åŒº Log åç§»é‡ã€‚å³ä½¿èŠ‚ç‚¹é‡å¯ï¼Œæˆ–è€…åˆ†åŒºè¿ç§»ï¼Œéƒ½èƒ½ä¿è¯ä»ä¸Šæ¬¡åŒæ­¥ä½ç½®é‡æ–°åŒæ­¥
3. æ ¹æ®åŒæ­¥æ—¥å¿—åŒæ­¥å˜æ›´çš„é…ç½®æµç¨‹æ˜¯å¹‚ç­‰çš„ï¼Œæ”¯æŒé‡å¤åŒæ­¥
4. å¢é‡ä¸€è‡´æ€§æ£€æµ‹ä»»åŠ¡è¿›è¡Œå…œåº•æ£€æµ‹

### 2.2.8.3 æ•°æ®å›ç¯è§£å†³

åŒæ­¥æ—¥å¿—åœ¨å¤åˆ¶ä¼ è¾“æ—¶ï¼Œåªä¼šä»ç›®æ ‡ IDC çš„ SourceSyncLog è¡¨ä¸­æŸ¥è¯¢ï¼Œå¹¶ä¿å­˜åœ¨æœ¬åœ°çš„ TargetSyncLog è¡¨ä¸­ï¼Œè€Œæ ¹æ® TargetSyncLog æ‰§è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹ä¸ä¼šäº§ç”Ÿæ–°çš„ SourceSyncLogï¼Œé¿å…äº†æ•°æ®å›ç¯çš„æ¡ä»¶ã€‚å³ ***å¼‚åœ°é…ç½®å˜æ›´ -> SourceSyncLog -> TargetSyncLog -> æœ¬åœ°é…ç½®***ã€‚

# 2.3 ä¸Šçº¿æ–¹æ¡ˆ

### 2.3.1 å‰æœŸå‡†å¤‡

1. BJï¼ŒSH ä¾§åˆ›å»ºåŒæ­¥å…ƒæ•°æ®è¡¨ï¼šIDC Router, Partitions, Offsetsï¼›åŒæ­¥æ—¥å¿—è¡¨ï¼šSourceSyncLog, TargetSyncLog
2. BJï¼ŒSH ä¾§é…ç½®åŒæ­¥ç›¸å…³å…ƒæ•°æ®
3. BJï¼ŒSH ä¾§æ·»åŠ åŒæ­¥å¼€å…³é…ç½®ï¼Œç”¨äºæ–°æ—§ç‰ˆæœ¬æ•°æ®åŒæ­¥æ–¹æ¡ˆåˆ‡æ¢ï¼ˆé»˜è®¤å…³é—­ï¼Œä½¿ç”¨æ—§æ–¹å¼è¿›è¡ŒåŒæ­¥ï¼‰

### 2.3.2 ä¸Šçº¿æ­¥éª¤

1. BJï¼ŒSH æœåŠ¡å‘å¸ƒï¼šManager, Consistency, Metaï¼›æ­¤æ—¶é…ç½®å˜æ›´ä¼šæ’å…¥ Log è‡³ SourceSyncLogï¼Œä½†ä¸é€šè¿‡è¯¥æ—¥å¿—è¿›è¡ŒåŒæ­¥
2. å¼€å¯ SH ä¾§åŒæ­¥å¼€å…³ï¼šæ­¤æ—¶ BJ -> SH é‡‡å–æ–°æ–¹æ¡ˆåŒæ­¥ï¼ŒSH -> BJ ä»é‡‡ç”¨æ—§æ–¹æ¡ˆåŒæ­¥
    1. *è®°å½•ä¸‹æ—¶é—´æˆ³ T1ï¼Œç”¨äºå¼‚å¸¸ä¿®å¤*
3. è§‚å¯Ÿç›‘æ§ï¼š
    1. åŒæ­¥æµç¨‹æ­£ç¡®æ€§ï¼ŒåŒæ­¥æ—¥å¿—å †ç§¯æƒ…å†µï¼ŒåŒæ­¥å»¶è¿Ÿï¼ŒåŒ—ä¸Šæ•°æ®ä¸€è‡´æ€§ï¼Œå¢é‡ä¸€è‡´æ€§æ£€æµ‹ä»»åŠ¡æ˜¯å¦æ­£å¸¸æ‰§è¡Œç­‰
    2. é€šè¿‡å…¨é“¾è·¯ç›‘æ§æŸ¥çœ‹é…ç½®å˜æ›´æ¨é€æ˜¯å¦æ­£å¸¸
    3. åŒæ—¶ï¼Œè§‚å¯Ÿ SH ä¾§ Offsets æ˜¯å¦æŒç»­å¢é•¿
    4. æ‰‹åŠ¨è°ƒæ•´ SH ä¾§ Consistency èŠ‚ç‚¹çŠ¶æ€ï¼Œè§‚å¯Ÿ Partitions æ˜¯å¦æ­£å¸¸è°ƒæ•´ï¼ŒåŒæ­¥ä»»åŠ¡æ˜¯å¦æ­£å¸¸è¿ç§»ï¼ŒåŒæ­¥å»¶è¿Ÿ/å †ç§¯æ˜¯å¦ç¬¦åˆé¢„æœŸ
4. å¼€å¯ BJ ä¾§åŒæ­¥å¼€å…³ï¼šæ­¤æ—¶ BJ <-> SH åŒå‘åŒæ­¥å‡é‡‡ç”¨æ–°æ–¹æ¡ˆ
    1. *è®°å½•ä¸‹å½“å‰æ—¶é—´æˆ³ T2ï¼Œç”¨äºå¼‚å¸¸ä¿®å¤*
5. æŒç»­è§‚å¯Ÿ SHï¼ŒBJ ä¾§åŒæ­¥ç›‘æ§

### 2.3.3 å›æ»šæ­¥éª¤

1. å…³é—­ SHï¼ŒBJ ä¾§åŒæ­¥å¼€å…³ï¼šåˆ‡å›æ—§åŒæ­¥æ–¹æ¡ˆ
2. è°ƒæ•´ SH ä¾§å¢é‡ä¸€è‡´æ€§æ£€æµ‹æ—¶é—´æˆ³ä¸º T1ï¼ŒBJ ä¾§æ—¶é—´æˆ³è°ƒæ•´ä¸º T2
    
    > prefix = lion.instance.last.check.timestamp
    > 
3. æŒç»­è§‚å¯Ÿç›‘æ§ï¼šåŒ—ä¸Šæ•°æ®ä¸€è‡´æ€§ï¼Œå˜æ›´æ¨é€å»¶è¿Ÿç­‰

## 2.4 éåŠŸèƒ½æ€§è®¾è®¡

1. åŒæ­¥ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ç›‘æ§
2. åŒæ­¥åˆ†åŒºå˜æ›´å‘¨çŸ¥
3. æ•°æ®ä¸ä¸€è‡´å‘Šè­¦
4. åŒæ­¥å»¶è¿Ÿç›‘æ§ï¼Œå‘Šè­¦
5. åŒæ­¥å †ç§¯å‘Šè­¦
6. å¤šæ¬¡åŒæ­¥å¤±è´¥å‘Šè­¦

# 3ã€é¡¹ç›®é£é™©ç‚¹

1. åŒæ­¥ä»»åŠ¡çš„ç®¡ç†
    1. èƒ½å¦å‡†ç¡®åˆ¤æ–­åŒæ­¥ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€
    2. Manager èƒ½å¦å‡†ç¡®å®ŒæˆåŒæ­¥ä»»åŠ¡çš„è¿ç§»ï¼Œèƒ½å¦åŠæ—¶ Kill ä¸å¯ç”¨ä»»åŠ¡å¹¶æ–°å»ºä»»åŠ¡
    3. åœ¨ Manager ç®¡ç†ä¸ç¬¦åˆé¢„æœŸçš„æƒ…å†µä¸‹ï¼Œéœ€è¦äººä¸ºä»‹å…¥ï¼Œæ‰‹åŠ¨æ‰§è¡Œä»»åŠ¡çš„åˆ é™¤ä¸åˆ›å»º
2. Offset ä¸ŠæŠ¥æ—¶æœº
    1. æ¯å›æ”¾ä¸€æ¡ Log å°±ä¸ŠæŠ¥ Offset å¯ä»¥ä¿è¯å¯é æ€§ï¼Œä½†æ˜¯æ€§èƒ½ä¼šæœ‰æ‰€æŸè€—
    2. æ˜¯å¦å¯ä»¥è°ƒæ•´ Offset ä¸ŠæŠ¥æ—¶æœºï¼Œå¦‚å‘¨æœŸä¸ŠæŠ¥ï¼Œè¿™æ ·å¯ä»¥æé«˜éƒ¨åˆ†æ€§èƒ½ï¼Œä½†æ˜¯åœ¨ä»»åŠ¡è¿ç§»æ—¶å¯èƒ½ä¼šæœ‰ Log é‡å¤åŒæ­¥ï¼Œéœ€è¦è¿›è¡Œæƒè¡¡
3. åŒæ­¥ä¸€è‡´æ€§ä¿è¯
    1. åœ¨æ–°æ–¹æ¡ˆä¸Šçº¿æœŸé—´ï¼Œå¦‚æœæ•°æ®ä¸ä¸€è‡´æ¦‚ç‡è¾ƒé«˜ï¼Œéœ€è¦åŠæ—¶åˆ‡æ¢æ—§æ–¹æ¡ˆ
    2. æ–°æ–¹æ¡ˆåœ¨åŒ—ä¸Šæ•°æ®ä¸­å¿ƒå¾—åˆ°éªŒè¯ï¼Œå¹¶ä¸”é•¿æ—¶é—´è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œæ‰èƒ½æ¨å¹¿åˆ°å¤šæ•°æ®ä¸­å¿ƒ

# 4ã€FAQ

Qï¼šWriter ä»»åŠ¡è°ƒåº¦ç®¡ç†æ¯”è¾ƒå¤æ‚ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ª Writer ä»»åŠ¡åŒæ­¥å…¨é‡æ•°æ®ï¼Œæ˜¯å¦å¯è¡Œï¼Ÿ

Aï¼šå¦‚æœåªæœ‰ä¸€ä¸ª Writer ä»»åŠ¡è¿›è¡ŒåŒæ­¥ï¼Œé‚£ä¹ˆ Writer åŒæ­¥æ€§èƒ½éœ€è¦å°½å¯èƒ½é«˜ï¼Œæœ€ä½è¦æ”¯æŒ 2000QPSã€‚

- æŒ‰ç…§å½“å‰çš„åŒæ­¥é€»è¾‘ï¼Œå•ä¸ªåŒæ­¥ä»»åŠ¡è‚¯å®šæ— æ³•æ”¯æ’‘ï¼šå•æ¡æ—¥å¿—é¡ºåºåŒæ­¥è€—æ—¶ TP999 48.4ms
- ä¼˜åŒ–å•æ¡æ—¥å¿—é¡ºåºåŒæ­¥ -> æ‰¹é‡åŒæ­¥ï¼šç®€å•æµ‹è¯•äº†ä¸‹ï¼Œæ€§èƒ½å¤§æ¦‚æå‡ 20% å·¦å³ï¼Œä¸å¤ªèƒ½æ»¡è¶³è¦æ±‚ï¼ˆå¯èƒ½ä»å­˜åœ¨ä¼˜åŒ–ç©ºé—´ï¼›å•æ‰¹æ¬¡æ—¥å¿—æ•°é‡ä¸èƒ½è¿‡å¤šï¼Œå¯èƒ½ä¼šå¼•å‘å¤§äº‹åŠ¡ï¼‰

æˆ‘ä»¬å°†åŒæ­¥ä»»åŠ¡è¿›è¡Œåˆ‡ç‰‡å¤„ç†ï¼Œ**é™¤äº†æ€§èƒ½å› ç´ ï¼Œè¿˜æœ‰æœåŠ¡æ‰©å±•æ€§è€ƒè™‘**ã€‚

- éšç€ä¸šåŠ¡é…ç½®å¢åŠ ï¼Œæ•°æ®ä¸­å¿ƒé€æ­¥å»ºè®¾ï¼ŒåŒæ­¥ä»»åŠ¡è¦æ”¯æŒæ°´å¹³æ‰©å±•ä»¥ä¿è¯ SLA
- åŒæ­¥ä»»åŠ¡è°ƒåº¦ç®¡ç†è™½ç„¶æ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯éƒ¨åˆ†é€»è¾‘ï¼ˆå¦‚åˆ†åŒºè¿ç§»ï¼‰å·²ç»ç»è¿‡çº¿ä¸ŠéªŒè¯ï¼Œå…¶ç¨³å®šæ€§åŠæ‰©å±•æ€§èƒ½å¤Ÿå¾—åˆ°ä¿éšœ

å› æ­¤ï¼Œæˆ‘ä»¬ä»å€¾å‘ç»§ç»­é‡‡ç”¨ä»»åŠ¡åˆ‡ç‰‡çš„å½¢å¼ã€‚

Qï¼šèƒ½å¦çµæ´»è°ƒæ•´æ•°æ®ä¸­å¿ƒåŒæ­¥æ–¹å‘ï¼Ÿå¦‚å°†é¦™æ¸¯ -> åŒ—äº¬çš„åŒæ­¥é“¾è·¯åˆ‡æ–­ï¼Œæˆ–è€…é¦™æ¸¯ä¾§æ•°æ®ä¸­å¿ƒä¸ä¸å…¶ä»–æ•°æ®ä¸­å¿ƒåŒæ­¥

Aï¼šé€šè¿‡æ›´æ–° IDC Router é…ç½®å³å¯è°ƒæ•´æ•°æ®ä¸­å¿ƒé—´çš„åŒæ­¥æ–¹å‘ï¼ˆsource_idc -> target_idcï¼‰

- æ›´æ–° IDC Router çš„ status å­—æ®µå¯ä»¥è°ƒæ•´åŒæ­¥æ–¹å‘å¼€å¯ä¸å¦
- æ–°å¢ IDC Router è®°å½•å¯ä»¥æ–°å¢åŒæ­¥é“¾è·¯

Qï¼šèƒ½å¦æ”¯æŒ Appkey ç²’åº¦åŒæ­¥æ–¹å‘æ§åˆ¶ï¼Ÿå¦‚ lion-demo é¡¹ç›®åªå¯ä»¥ä»åŒ—äº¬åŒæ­¥åˆ°ä¸Šæµ·

Aï¼šå¯ä»¥æ”¯æŒã€‚ä¸è¿‡åªæŒ‰ç…§å‰é¢çš„æè¿°è¿˜ä¸èƒ½æ»¡è¶³ï¼Œéœ€è¦é¢å¤–çš„é…ç½®ï¼Œå¦‚æ¯ä¸ªæ•°æ®ä¸­å¿ƒæ–°å¢ä¸€ä¸ªè¡¨ IDCFilterï¼Œåœ¨è¯¥è¡¨ä¸­é…ç½®å“ªäº› IDC ä¸­çš„ Appkey, Key ä¸éœ€è¦è¿›è¡ŒåŒæ­¥ã€‚

åœ¨åŒæ­¥ä»»åŠ¡è¿›è¡Œæ—¥å¿—è¿‡æ»¤æ—¶ç›´æ¥å¿½ç•¥å¯¹åº”çš„ IDC, Appkey, Key å³å¯å®ç°ã€‚

Qï¼šèƒ½å¤Ÿæ”¯æŒéƒ¨åˆ†ä¸šåŠ¡åŒæ­¥æµç¨‹éš”ç¦»ï¼Ÿå¦‚æ•°æ®åº“ç›¸å…³é…ç½®ä¸æ™®é€šä¸šåŠ¡é…ç½®åŒæ­¥éš”ç¦»

Aï¼šå¯ä»¥æ”¯æŒï¼›å°†ç‰¹å®šèŒƒå›´çš„åˆ†åŒºï¼ˆå¦‚ 1000 ï½ 1024ï¼‰å•ç‹¬åˆ’åˆ†å‡ºæ¥ç»™æŒ‡å®šä¸šåŠ¡ä½¿ç”¨ã€‚

åœ¨åˆ†åŒºç´¢å¼•è®¡ç®—æ—¶è¿›è¡Œè®¾è®¡ï¼Œä¿è¯æŒ‡å®šçš„ Appkey åˆ—è¡¨åªä¼šè·¯ç”±åˆ°ç‰¹å®šçš„åˆ†åŒºï¼Œè€Œå…¶ä»–ä¸šåŠ¡ Appkey è·¯ç”±åˆ°å…¶ä»–åˆ†åŒºã€‚

Qï¼šLion çŸ­æœŸå†…ä»ä¸èƒ½å®Œå…¨ä¸‹æ‰ Redisï¼Œå¯¹ Redis åŒæ­¥å¦‚ä½•å¤„ç†ï¼Ÿ

Aï¼šåŒæ­¥ä»»åŠ¡åœ¨å›æ”¾æ—¥å¿—æ—¶ï¼Œå…ˆåŒæ­¥ DBï¼Œä¹‹åå†åŒæ­¥ Redisã€‚ç°æœ‰ç›‘æ§æ¥çœ‹ï¼ŒRedis æ•°æ®åŒæ­¥è€—æ—¶ TP999 71.3msï¼Œå¹³å‡ 4.2msï¼Œå¯¹åŒæ­¥å»¶è¿Ÿå½±å“æœ‰é™ï¼Œå¯ä»¥ç›´æ¥åŒæ­¥ã€‚

ç­‰ Redis å®Œå…¨ä¸‹æ‰ä¹‹åï¼Œåœ¨é€šè¿‡å¼€å…³ç§»é™¤ Redis åŒæ­¥æµç¨‹ã€‚

Qï¼šç›®å‰é’ˆå¯¹åŒ—ä¸Šä¸¤ä¸ªæ•°æ®ä¸­å¿ƒï¼ŒLion æ–‡ä»¶é…ç½®åœ¨æ›´æ–°æ—¶ä¼šå°†æ–‡ä»¶å†…å®¹åŒæ—¶æ›´æ–°åˆ°åŒ—ä¸Šä¸¤ä¸ª S3 é›†ç¾¤ï¼Œåœ¨åŒæ­¥æ—¶åªåŒæ­¥æ–‡ä»¶ SHA Keyã€‚å¦‚æœæ‰©å±•åˆ°å¤šä¸ªé›†ç¾¤ï¼Œé’ˆå¯¹æ–‡ä»¶é…ç½®å¦‚ä½•å¤„ç†ï¼Ÿ

Aï¼šå¯¹äºæ–‡ä»¶é…ç½®ï¼Œåœ¨åŒæ­¥ SHA Key åï¼Œé€šè¿‡å•ç‹¬çš„çº¿ç¨‹ï¼Œä»æºæ•°æ®ä¸­å¿ƒ S3 é›†ç¾¤è¿›è¡Œæ–‡ä»¶åŠ è½½ï¼ŒåŒæ­¥åˆ°æœ¬åœ° S3 é›†ç¾¤ã€‚

å¦‚æœä»æºæ•°æ®ä¸­å¿ƒçš„ S3 é›†ç¾¤åŠ è½½å¤±è´¥ï¼Œåˆ™æŒ‰ç…§é¡ºåºï¼ˆBJ > HL > SH > HKï¼‰é™çº§è¿›è¡Œé‡æ–°æ‹‰å–ã€‚

# 5ã€å…¶ä»–è¡¥å……

1. [https://km.sankuai.com/page/28131829#id-%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D](https://km.sankuai.com/page/28131829#id-%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D)
2. [https://km.sankuai.com/page/600429548](https://km.sankuai.com/page/600429548)
3. [https://dbaplus.cn/news-11-1399-1.html](https://dbaplus.cn/news-11-1399-1.html)
4. [https://km.sankuai.com/collabpage/1407987923](https://km.sankuai.com/collabpage/1407987923)
5. [https://km.sankuai.com/page/1476581664](https://km.sankuai.com/page/1476581664)
6. [https://km.sankuai.com/page/617657890](https://km.sankuai.com/page/617657890)
7. [https://km.sankuai.com/collabpage/1532367225](https://km.sankuai.com/collabpage/1532367225)





