---

layout: post
title: "Dynamo: Amazon's Highly Available Key-value Store"
category: "system-design"
author: "kkzhang"
---

# 1-Abstract

Dynamo 是 Amazon 提出的**高可用键值存储**系统。为了保证系统的高可用，*牺牲了一些特定场景下的一致性*。Dynamo 使用了**对象版本化（object versioning）**与**应用协助解决冲突（application-assisted conflict resolution）**的机制。

# 2-Introduction

Amazon 的基础设施由数百万台设备组成，任何时刻都会有比例小但是数量不少的设备发生故障。因此，可以将故障看作是正常的，可预期的行为，*软件系统不应该因为硬件设备故障影响自身的可用性与性能*。

Dynamo 的目标是实现一个**永远可用（always available）**的系统：即使服务器故障或者网络异常，用户也能往自己的购物车里添加商品。基于以下技术保证了高可用性与高扩展性：

- 数据通过**一致性 Hash 进行分区与复制**
- 通过**对象版本化**实现一致性（最终一致性）
- 数据副本之间的一致性通过“**类似仲裁的技术**”与“**去中心化的副本同步协议**”保证
- 以 gossip 协议为基础的分布式**故障检测与成员检测**协议

Dynamo 系统通过组合不同的技术实现一个高度可用（high-available）的系统，并证明了最终一致性存储系统可以用于生产环境，满足应用的高可用要求。

# 3-Background

Amazon 电商平台由几百个服务组成，有些服务是无状态的（如聚合其他服务响应的服务），有些服务是有状态的（如基于存储在数据仓库中的状态，执行业务逻辑并产生响应的服务）。传统上，服务状态使用关系型数据库存储；但是，对很多**持久状态的存储**需求来说，关系型数据库有一些局限性：

- 该类型的服务大部分情况下只需要**使用主键检索**，并不需要关系型数据库提供的复杂查询和管理功能
- 关系型数据库的复制功能受限，而且通常通过**牺牲可用性来换取一致性**；水平扩展（scale-out）不足

针对关系型数据库的不足，Dynamo 能够做到高度可用，有定义清晰的一致性窗口（clearly defined consistency window），易用的水平扩展方案。

> Dynamo 支持独立部署，不同的业务使用不同的 Dynamo 系统
> 

## 3-1-**System Assumptions and Requirements**

对接入 Dynamo 的服务有以下假设：

1. 查询模型（*Query Model*）
    1. 通过*唯一 key* 进行数据读写操作
    2. 任何读写操作都*不会跨多个数据单元*（data item）
    3. 没有关系型 schema 需求
    4. 需要存储的*文件较小*（< 1MB）
2. ACID 特性（*ACID Properties*）
    1. 在数据库领域中，ACID 是保证事务可靠执行的保证；但是这些特性会牺牲系统的可用性。Dynamo 实现目标是：*允许通过牺牲一些一致性（C）提高可用性*
    2. Dynamo *不提供任何隔离保证*，只允许单个key 的更新操作
3. 效率（*Efficiency*）
    1. 系统需要满足严格的 SLA（通过 TP999 衡量）；并允许业务自定义配置 Dynamo 以满足吞吐量 & 延迟的需求

## 3-2-**Design Considerations**

*为了达到强一致性，一般数据库会采用同步复制算法*。这类算法在某些故障场景下牺牲了可用性，如当数据出现冲突，则暂时禁止对该数据的访问，直到冲突解决。

分布式系统是无法同时满足 C（强一致性），A（高可用性），P（网络故障容忍）三个特性；因此，在不同的业务场景下需要选择不同的特性：是强一致性还是高可用性。

在服务器与网络故障比较高的场景下，可以通过**乐观复制**（optimistic replication）提高可用性：在后台通过异步同步将数据变更复制到其他节点，能够容忍并发更新与操作异常。不过这种方式虽然能够提高可用性，但是会导致数据冲突，需要检测并修复冲突。那么：

- 什么时候解决冲突
- 由谁解决冲突

> Dynamo 被设计为**最终一致性数据仓库（eventually consistent data store）**，所有的数据变更最后都会同步到所有副本

1. **什么时候解决冲突**
    
    解决冲突的时机有两个：读时 & 写时。
    
    传统数据库在写时解决冲突，可以使得读操作比较简单。这种方式在*系统不能访问大部分（或者全部）副本时，就会拒绝写*。
    
    Dynamo 期望保证**永远可写**（always writeable），所以在*数据读取时解决冲突*，以保证写操作不会被拒绝。
    
2. **谁解决冲突**
    
    冲突解决方也有两个：业务服务 & 数据库。
    
    如果由数据库来解决，只能执行一些简单的策略，如最后写有效（last write wins）。
    
    由于业务服务能够更了解数据的作用，可以更加*灵活地选择对用户体验最好的冲突解决算法*，如合并冲突的版本。
    
3. 其他设计原则
    1. **增量扩展性（Incremental scalability）**：支持逐个节点扩容，并减小对系统的影响
    2. **对称性（Symmetry）**：*每个节点的职责应该是相同的*；对称性简化了系统的运维
    3. **去中心化（Decentralization）**：去中心化是对称性的进一步扩展；系统应该是去中心化，点对点的，而不是集中控制；*去中心化能够使得系统更加简单，更具可扩展性 & 可用性*
    4. 异构性（Heterogeneity）：负载的分布要与节点的承载能力成正比
