<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>DDIA: 数据复制（二）</title><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="DDIA: 数据复制（二）" />
<meta name="author" content="kkzhang" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="多主节点复制" />
<meta property="og:description" content="多主节点复制" />
<link rel="canonical" href="http://localhost:4000/ddia-6.html" />
<meta property="og:url" content="http://localhost:4000/ddia-6.html" />
<meta property="og:site_name" content="Find a needle in haystack" />
<meta property="og:image" content="http://localhost:4000/ddia/ddia_6_1.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-07T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/ddia/ddia_6_1.png" />
<meta property="twitter:title" content="DDIA: 数据复制（二）" />
<script type="application/ld+json">
{"image":"http://localhost:4000/ddia/ddia_6_1.png","author":{"@type":"Person","name":"kkzhang"},"@type":"BlogPosting","description":"多主节点复制","headline":"DDIA: 数据复制（二）","dateModified":"2021-07-07T00:00:00+08:00","datePublished":"2021-07-07T00:00:00+08:00","url":"http://localhost:4000/ddia-6.html","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/ddia-6.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Find a needle in haystack" /><link rel="shortcut icon" type="image/x-icon" href="/logo.ico" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="auto">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">../</a><article>
  <p class="post-meta">
    <time datetime="2021-07-07 00:00:00 +0800">2021-07-07</time>
  </p>
  
  <h1>DDIA: 数据复制（二）</h1>

  <h1 id="多主节点复制">多主节点复制</h1>

<p>主从复制的缺点是：只有一个主节点，所有写入都必须经过主节点；那么系统的写入操作可扩展性不强，同时如果主节点异常阶段会使得系统写入被阻塞。</p>

<p>可以根据主从模型进行扩展，配置多个主节点，<strong>每个主节点都可以接受写请求；每个主节点都需要将数据更改转发到其他所有节点</strong>，这种方式被称为<strong>多主节点复制</strong>。</p>

<blockquote>
  <p>每个主节点同时是其他主节点的从节点</p>
</blockquote>

<h2 id="适用场景">适用场景</h2>

<h3 id="多数据中心">多数据中心</h3>

<p>在一个数据中心内适用多个主节点没有太大意义，反而使系统更加复杂，比较合适的场景是多数据中心。</p>

<p>为了容忍数据中心级别的故障，可以把数据库的副本横跨多个数据中心。可以<strong>在每个数据中心配置一个主节点；每个数据中心内采用常规的主从复制方案；而在数据中心之间，各个数据中心的主节点来负责同其他数据中心的主节点进行数据交换，更新</strong>。</p>

<blockquote>
  <p>对于多数据中心，如果采用主从复制，由于主节点只能存在其中一个数据中心内，会导致所有写请求都会经过该中心，反而会影响系统性能</p>
</blockquote>

<p><img src="/images/ddia/ddia_6_1.png" alt="" /></p>

<blockquote>
  <p>横跨多数据中心的多主节点复制模型</p>
</blockquote>

<p>如果数据库还采用了分区，那么不同分区的主副本可能存放在不同的主节点上，但是对于给定的某个分区，只有一个主节点。</p>

<h3 id="多主复制-vs-主从复制">多主复制 VS 主从复制</h3>

<ol>
  <li>
    <p>性能</p>

    <p>对于主从复制，每个写请求都需要发送到主节点所在的数据中心，会导致延迟大大增加。</p>

    <p>在多主复制中，每个写操作都可以在本地数据中心操作，然后采用异步复制的方式将更新同步到其他数据中心，性能更好。</p>
  </li>
  <li>
    <p>数据中心失效容忍</p>

    <p>如果主从复制的主节点所在中心失效，那么需要从另一个数据中选取从节点作为主节点。</p>

    <p>在多主节点模型中，每个数据中心都可以独立与其他中心运行；可以等到失效的中心恢复后再将数据同步过去。</p>
  </li>
  <li>
    <p>网络问题容忍</p>

    <p>数据中心之间的通信没有中心内可靠。对于主从复制，写操作是同步操作，对于中心之间的网络稳定性更加依赖；多主节点模型通常采用异步复制，能够更好容忍这类问题。</p>
  </li>
</ol>

<p>虽然多主复制有各种优势，但是也有一个很大的缺点：<strong>不同数据中心可能会同时修改相同的数据，因而产生写冲突</strong>。</p>

<h2 id="处理写冲突">处理写冲突</h2>

<p>两个用户同时编辑 wiki 页面，用户 1 将标题从 A 改为 B，同时用户 2 将标题从 A 改成了 C。每个用户都将更新顺利提交到本地主节点，但是当数据被异步复制到对方时，发现存在写冲突。</p>

<p><img src="/images/ddia/ddia_6_2.png" alt="" /></p>

<blockquote>
  <p>多个主节点同时更新同一条记录产生写冲突</p>
</blockquote>

<p>处理写冲突的方案有：</p>

<ol>
  <li>
    <p>同步与异步冲突检测</p>

    <p>同步冲突检测：等待写请求同步到所有副本后，再通知用户写入成功；但是这样会失去多主节点的优势。</p>
  </li>
  <li>
    <p>避免冲突</p>

    <p>在应用层保证对特定记录的写请求总是通过同一个主节点，这样就不会产生写冲突。</p>
  </li>
  <li>
    <p>收敛于一致状态</p>

    <p>不管是主从复制还是多主复制，至少应该确保数据在所有副本中的最终状态一定是一致的。实现收敛可能有以下方式：</p>

    <ul>
      <li>每个写入分配 uuid，挑选最高的 id 写入作为胜利者，被称为<strong>最后写入者获胜</strong>。但是这种方式很<strong>容易造成数据丢失</strong>。</li>
      <li>以某种方式将冲突的值合并，例如按照字母顺序排序后拼接，A/B</li>
    </ul>
  </li>
</ol>

<h3 id="多主复制的拓扑结构">多主复制的拓扑结构</h3>

<p>复制的拓扑结构<em>描述了写请求从一个节点传播到其他节点的通信路径</em>。</p>

<p>常见的拓扑结构有：</p>

<p><img src="/images/ddia/ddia_6_3.png" alt="" /></p>

<ul>
  <li>环形拓扑
    <ul>
      <li>每个节点接收来自前序节点的写入，并将这些写入（加上自己的的写入）转发给后序节点</li>
    </ul>
  </li>
  <li>星型拓扑
    <ul>
      <li>一个指定的根节点将写入转发给所有其他节点</li>
    </ul>
  </li>
  <li>全部至全部型
    <ul>
      <li>每个主节点将其写入同步到其他所有主节点</li>
    </ul>
  </li>
</ul>

</article>
      </div>
    </main>
  </body>
</html>